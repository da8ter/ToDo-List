<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <script src="/icons.js"></script>
  <style>
    :root {
      --bg: var(--card-color);
      --card: var(--card-color);
      --text: var(--content-color);
      --muted: color-mix(in srgb, var(--content-color) 30%, transparent);
      --border: color-mix(in srgb, var(--accent-color) 30%, transparent);
      --accent: var(--accent-color);
      --radius: 14px;
      --gap: 12px;
    }

    body {
      color: var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: transparent;
    }
    .wrap {
      position: relative;
      height: 100%;
      min-height: 0;
      padding: 0;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      gap: var(--gap);
      overflow: hidden;
    }
    .add {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }
    .add .full { grid-column: 1 / -1; }

    .overlay {
      position: absolute;
      inset: 0;
      padding: 0;
      box-sizing: border-box;
      display: none;
      flex-direction: column;
      gap: var(--gap);
      overflow: hidden;
      align-items: stretch;
      justify-content: flex-start;
      z-index: 1000;
    }
    .overlay::-webkit-scrollbar { display: none; }
    #overlay {
      background: var(--bg);
      backdrop-filter: none;
    }
    #detailOverlay {
      background: var(--bg);
      backdrop-filter: none;
    }
    .overlay.open { display: flex; }
    .overlay-card {
      background: var(--card);
      border: 0px solid var(--border);
      border-radius: 0;
      display: flex;
      flex-direction: column;
      width: 100%;
      height: 100%;
      min-height: 100%;
      max-height: 100%;
      overflow: hidden;
    }
    .overlay-card::-webkit-scrollbar { display: none; }
    .overlay-body {
      display: flex;
      flex-direction: column;
      gap: 10px;
      flex: 1 1 auto;
      min-height: 0;
      overflow: auto;
      scrollbar-width: thin;
      scrollbar-color: color-mix(in srgb, var(--accent) 70%, transparent) transparent;
      padding: var(--gap);
    }
    .overlay-body::-webkit-scrollbar { width: 6px; height: 6px; }
    .overlay-body::-webkit-scrollbar-track { background: transparent; }
    .overlay-body::-webkit-scrollbar-thumb {
      background: color-mix(in srgb, var(--accent) 70%, transparent);
      border-radius: 999px;
    }
    .detail-card {
      max-height: 100%;
      overflow: hidden;
    }
    .detail-title {
      font-weight: 700;
      font-size: 16px;
      overflow-wrap: anywhere;
    }
    .detail-info {
      color: var(--text );
      font-size: 13px;
      white-space: pre-wrap;
      overflow-wrap: anywhere;
    }
    .detail-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
    }
    .overlay-title {
      font-weight: 700;
    }
    .overlay-actions {
      display: flex;
      gap: 8px;
      background: var(--card);
      padding: 10px var(--gap) var(--gap);
      border-top: 1px solid var(--border);
      border-radius: 0 0 var(--radius) var(--radius);
      flex: 0 0 auto;
    }
    .overlay-actions button { flex: 1; }
    .checkrow {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      font-size: 13px;
      user-select: none;
    }
    .checkrow label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      flex: 0 0 auto;
    }
    .hint {
      font-size: 12px;
      color: var(--muted);
      line-height: 1.2;
    }
    .field-label {
      font-size: 12px;
      font-weight: 600;
      color: var(--muted);
      margin-top: 2px;
      margin-bottom: 5px;
    }
    .checkrow select {
      flex: 1 1 auto;
      min-width: 0;
    }
    .checkrow .select-wrap {
      flex: 1 1 auto;
      min-width: 0;
    }
    .checkrow input[type="checkbox"] {
      width: 18px;
      height: 18px;
      margin: 0;
      padding: 0;
      flex: 0 0 auto;
    }
    .date-input {
      position: relative;
      width: 100%;
      color: var(--text);
    }
    .date-input input {
      padding-right: 40px;
      position: relative;
      z-index: 1;
    }
    .date-input:not(.has-value):not(.is-focused) input {
      color: transparent;
    }
    .date-input .date-placeholder {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      pointer-events: none;
      color: var(--muted);
      font-size: 13px;
      z-index: 2;
    }
    .date-input .cal-icon {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      pointer-events: none;
      color: inherit;
      z-index: 3;
    }
    #due::-webkit-calendar-picker-indicator { opacity: 0; }
    input:not([type="checkbox"]), select {
      width: 100%;
      box-sizing: border-box;
      border-radius: 10px;
      border: 1px solid var(--border);
      padding: 10px 12px;
      background: var(--bg);
      color: var(--text);
      outline: none;
    }
    button {
      border-radius: 10px;
      border: 1px solid var(--border);
      padding: 10px 12px;
      background: var(--card);
      color: var(--text);
      cursor: pointer;
      transition: transform .04s ease, border-color .12s ease;
      white-space: nowrap;
    }
    button:active { transform: scale(.98); }
    button.primary { border-color: var(--accent); background-color: var(--accent); }
    button.danger { border-color: rgb(255, 0, 0); background-color: rgb(255, 0, 0); }

    .list {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 8px;
      overflow: auto;
      scrollbar-width: thin;
      scrollbar-color: color-mix(in srgb, var(--accent) 70%, transparent) transparent;
    }
    .list::-webkit-scrollbar { width: 6px; height: 6px; }
    .list::-webkit-scrollbar-track { background: transparent; }
    .list::-webkit-scrollbar-thumb {
      background: color-mix(in srgb, var(--accent) 70%, transparent);
      border-radius: 999px;
    }

    .list.grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      grid-auto-rows: min-content;
      align-content: start;
      gap: 8px;
    }
    .list.grid.shopping {
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 6px;
    }
    .list.grid .section-header { grid-column: 1 / -1; }
    .list.grid .item {
      flex-direction: column;
      align-items: center;
      justify-content: space-between;
      text-align: center;
      aspect-ratio: 1 / 1;
      overflow: hidden;
      min-height: 0;
    }
    .list.grid.shopping .item { padding: calc(var(--gap) / 2); }
    .list.grid .item .main {
      flex-direction: column;
      align-items: center;
      width: 100%;
      flex: 1 1 auto;
      min-height: 0;
      overflow: auto;
      scrollbar-width: thin;
      scrollbar-color: color-mix(in srgb, var(--accent) 70%, transparent) transparent;
    }
    .list.grid .item .main::-webkit-scrollbar { width: 6px; height: 6px; }
    .list.grid .item .main::-webkit-scrollbar-track { background: transparent; }
    .list.grid .item .main::-webkit-scrollbar-thumb {
      background: color-mix(in srgb, var(--accent) 70%, transparent);
      border-radius: 999px;
    }
    .list.grid.shopping .item .main { overflow: hidden; }
    .list.grid.shopping .chk { display: none; }
    .list.grid .item .content {
      width: 100%;
      flex: 0 0 auto;
      min-height: 0;
      overflow: visible;
    }
    .list.grid.shopping .item .content {
      display: flex;
      flex-direction: column;
      flex: 1 1 auto;
      min-height: 0;
    }
    .list.grid.shopping .title {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .list.grid.shopping .info {
      display: block;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .list.grid.shopping .shopping-qty-wrap {
      flex: 1 1 auto;
      min-height: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
    }
    .list.grid .item .actions {
      width: 100%;
      margin-left: 0;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    .list.grid .title { font-size: 1.5em; }
    .list.grid.shopping .title { font-size: 1.05em; }
    .list.grid .item .meta {
      justify-content: center;
      flex-wrap: wrap;
    }
    .list.grid .item .grid-actions {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: calc(var(--gap) / 2);
      width: 100%;
    }
    .badge.icon-only {
      width: 24px;
      height: 24px;
      padding: 0;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    .list.grid .badge.quantity:not(.large-qty) {
      height: 24px;
      padding: 0 8px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      box-sizing: border-box;
    }
    .badge.quantity.large-qty {
      font-size: 25px;
      line-height: 1;
      padding: 8px 14px;
      font-weight: 800;
    }
    .quantity-large-wrap {
      display: flex;
      justify-content: center;
      width: 100%;
      margin-top: calc(var(--gap) / 2);
    }
    .list.grid .quantity-large-wrap { margin-top: var(--gap); }

    .item {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: var(--gap);
      padding: var(--gap);
      border-radius: var(--radius);
      background: var(--card);
      border: 1px solid var(--border);
    }
    .item .main {
      display: flex;
      align-items: center;
      gap: var(--gap);
      flex: 1 1 200px;
      min-width: 0;
    }
    .item .actions {
      display: flex;
      align-items: center;
      gap: calc(var(--gap) / 2);
      flex-shrink: 0;
      margin-left: auto;
    }
    .item .chk {
      flex-shrink: 0;
      width: 18px;
      height: 18px;
      margin: 0;
    }
    .item .content {
      flex: 1;
      min-width: 0;
    }
    .title {
      font-weight: 700;
      font-size: 1em;
      line-height: 1.2;
      white-space: normal;
      overflow: visible;
      text-overflow: clip;
      word-break: break-word;
    }
    .info {
      color: var(--text);
      font-size: 12px;
      white-space: normal;
      overflow: visible;
      text-overflow: clip;
      line-height: 1.35;
      margin-top: calc(var(--gap) / 2);
      display: -webkit-box;
      -webkit-line-clamp: 2;
      line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    .item .meta {
      flex-shrink: 0;
      display: flex;
      gap: 6px;
      align-items: center;
    }
    .badge {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      color: var(--muted);
    }
    .badge.due-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .badge.due-badge .due-icon { color: inherit; }
    .badge.due-badge .due-icon { display: none; }
    .badge.due-badge.due-overdue { border-color: rgb(255, 0, 0); color: var(--text); background-color: rgb(255, 0, 0, 0.2); }
    .badge.due-badge.due-today { border-color: #ffa500; color: var(--text); background-color: rgb(255, 165, 0, 0.2); }
    .badge.notify-badge { border-color: var(--accent); color: var(--text); background-color: color-mix(in srgb, var(--accent) 20%, var(--bg)); }
    .badge.recur-badge { border-color: var(--accent); color: var(--text); background-color: color-mix(in srgb, var(--accent) 20%, var(--bg)); }
    .badge .icon-svg { width: 14px; height: 14px; display: block; fill: currentColor; }
    @media (max-width: 420px) {
      .badge.due-badge .due-text { display: none; }
      .badge.due-badge .due-icon { display: inline-block; }
    }
    .badge.high, .badge.normal, .badge.low {
      display: inline-flex;
      justify-content: center;
      min-width: 60px;
    }
    .badge.icon-only.high,
    .badge.icon-only.normal,
    .badge.icon-only.low {
      min-width: 24px;
    }
    .badge.high { border-color: rgb(255, 0, 0); color: var(--text); background-color: rgb(255, 0, 0, 0.2);}
    .badge.low { border-color: rgba(200,200,200,.25);  color: var(--text); background-color: rgb(200,200,200, 0.2);}
    .badge.normal { border-color: var(--accent-color); color: var(--text);  background-color: color-mix(in srgb, var(--accent-color) 30%, transparent);}
    .badge.quantity { border-color: var(--accent-color); font-weight: 700; color: var(--accent);}
    .item .del {
      flex-shrink: 0;
      padding: 6px 10px;
      font-size: 12px;
    }
    .danger-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .item .edit {
      flex-shrink: 0;
      padding: 6px 10px;
      font-size: 12px;
    }
    .item .icon-btn {
      padding: 0;
      width: 28px;
      height: 28px;
      box-sizing: border-box;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .item .drag-handle {
      flex-shrink: 0;
      width: 28px;
      height: 28px;
      box-sizing: border-box;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--card);
      cursor: grab;
      display: flex;
      align-items: center;
      justify-content: center;
      user-select: none;
    }
    .item .drag-handle:active { cursor: grabbing; }
    .item .drag-handle i {
      color: var(--muted);
      font-size: 16px;
      pointer-events: none;
    }
    .item.dragging {
      background: var(--accent);
      z-index: 10;
    }
    .item.drag-over {
      outline: 0px dashed var(--accent);
      outline-offset: 0px;
    }
    .done { opacity: .5; }
    .done .title { text-decoration: line-through; }
    .empty { color: var(--muted); padding: 10px; }
    .section-header {
      font-size: 12px;
      font-weight: 600;
      color: var(--muted);
      padding: 8px 4px 4px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .stats {
      display: flex;
      gap: var(--gap);
      margin-bottom: var(--gap);
    }
    .stat-box {
      flex: 1;
      padding: 12px 8px;
      border-radius: var(--radius);
      background: var(--card);
      border: 1px solid var(--border);
      text-align: center;
    }
    .stat-box .label {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 4px;
    }
    .stat-box .value {
      font-size: 28px;
      font-weight: 700;
    }
    .stat-open .label, .stat-open .value { color: var(--accent); }
    .stat-overdue .label, .stat-overdue .value { color: #ff5a5a; }
    .stat-today .label, .stat-today .value { color: #ffa500; }
    .toolbar {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: var(--gap);
      flex-wrap: nowrap;
    }
    .toolbar .sort {
      display: flex;
      align-items: center;
      gap: 8px;
      min-width: 0;
      flex: 1;
    }
    .select-wrap {
      position: relative;
      flex: 1;
      min-width: 0;
      color: var(--text);
    }
    .select-wrap select {
      padding-right: 40px;
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
    }
    .select-wrap .select-icon {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      pointer-events: none;
      color: inherit;
    }
    .toolbar.manual-sort #sortAsc,
    .toolbar.manual-sort #sortDesc {
      display: none;
    }
    #sortLabel { white-space: nowrap; }
    #sortSelect {
      min-width: 0;
      height: 28px;
      padding: 0 40px 0 12px;
      line-height: 28px;
    }
    .toolbar .sort-btn {
      height: 28px;
      width: 28px;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="stats">
      <div class="stat-box stat-open">
        <div class="label" id="statOpenLabel"></div>
        <div class="value" id="statOpenValue">0</div>
      </div>
      <div class="stat-box stat-overdue">
        <div class="label" id="statOverdueLabel"></div>
        <div class="value" id="statOverdueValue">0</div>
      </div>
      <div class="stat-box stat-today">
        <div class="label" id="statTodayLabel"></div>
        <div class="value" id="statTodayValue">0</div>
      </div>
    </div>
    <button id="newBtn" class="primary"> </button>

    <div class="toolbar">
      <div class="sort">
        <div id="sortLabel"></div>
        <div class="select-wrap">
          <select id="sortSelect"></select>
          <i class="fa-light fa-arrow-down-from-bracket select-icon"></i>
        </div>
      </div>
      <button class="sort-btn icon-btn" id="sortAsc" type="button"><i class="fa-light fa-arrow-up"></i></button>
      <button class="sort-btn icon-btn" id="sortDesc" type="button"><i class="fa-light fa-arrow-down"></i></button>
    </div>

    <div id="list" class="list"></div>

    <div id="overlay" class="overlay">
      <div class="overlay-card">
        <div id="formTitle" class="overlay-title"></div>
        <div class="overlay-body">
          <div class="add">
            <input id="title" type="text" class="full" />
            <input id="info" type="text" class="full" />
            <input id="quantity" type="number" min="0" class="full" />
            <div class="full select-wrap">
              <select id="prio">
                <option value="low"></option>
                <option value="normal" selected></option>
                <option value="high"></option>
              </select>
              <i class="fa-light fa-arrow-down-from-bracket select-icon"></i>
            </div>
            <div class="full date-input">
              <input id="due" type="datetime-local" />
              <div id="duePlaceholder" class="date-placeholder"></div>
              <i class="fa-light fa-calendar cal-icon"></i>
            </div>
            <div id="notificationFieldLabel" class="full field-label"></div>
            <div class="full checkrow"><label><input id="notification" type="checkbox" /><span id="notificationLabel"></span></label><div class="select-wrap"><select id="notificationLeadTime"></select><i class="fa-light fa-arrow-down-from-bracket select-icon"></i></div></div>
            <div id="notificationLeadTimeInfo" class="full hint"></div>
            <div id="recurrenceFieldLabel" class="full field-label"></div>
            <div id="recurrenceWrap" class="full select-wrap">
              <select id="recurrence"></select>
              <i class="fa-light fa-arrow-down-from-bracket select-icon"></i>
            </div>
            <div id="recurrenceCustomWrap" class="full" style="display:none; gap: 8px; align-items: center;">
              <div class="select-wrap" style="flex: 1 1 auto; min-width: 0;">
                <select id="recurrenceCustomUnit"></select>
                <i class="fa-light fa-arrow-down-from-bracket select-icon"></i>
              </div>
              <input id="recurrenceCustomValue" type="number" min="1" style="width: 90px;" />
            </div>
            <div id="recurrenceResetFieldLabel" class="full field-label"></div>
            <div id="recurrenceResetWrap" class="full select-wrap">
              <select id="recurrenceResetLeadTime"></select>
              <i class="fa-light fa-arrow-down-from-bracket select-icon"></i>
            </div>
          </div>
        </div>
        <div class="overlay-actions">
          <button id="deleteBtn" class="danger danger-btn" type="button"><i class="fa-light fa-trash-can"></i><span id="deleteBtnText"></span></button>
          <button id="cancelBtn" type="button"></button>
          <button id="addBtn" class="primary"></button>
        </div>
      </div>
    </div>

    <div id="detailOverlay" class="overlay">
      <div class="overlay-card detail-card">
        <div class="overlay-body">
          <div id="detailHeader" class="overlay-title"></div>
          <div id="detailTaskTitle" class="detail-title"></div>
          <div id="detailTaskInfo" class="detail-info"></div>
          <div id="detailMeta" class="detail-meta"></div>
        </div>
        <div class="overlay-actions">
          <button id="detailCloseBtn" class="primary"></button>
        </div>
      </div>
    </div>
  </div>

  <script>
    (() => {
    let state = { items: [] };
    let editingId = 0;
    let dragItem = null;
    let dragGroup = '';
    let dndBound = false;
    let sortMode = 'created';
    let sortDir = 'desc';
    let lastOrderVersion = null;

    const translate = (typeof window.translate === 'function')
      ? window.translate
      : (key) => String(key ?? '');

    const requestAction = (typeof window.requestAction === 'function')
      ? window.requestAction
      : (ident, value) => {
          try {
            window.parent.postMessage(JSON.stringify({ type: 'requestAction', ident: String(ident), value }), '*');
          } catch (e) {
          }
          try {
            window.parent.postMessage({ type: 'requestAction', ident: String(ident), value }, '*');
          } catch (e) {
          }
        };

    const bellSvg = '<svg class="icon-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640"><path d="M320 64C306.7 64 296 74.7 296 88L296 97.7C214.6 109.3 152 179.4 152 264L152 278.5C152 316.2 142 353.2 123 385.8L101.1 423.2C97.8 429 96 435.5 96 442.2C96 463.1 112.9 480 133.8 480L506.2 480C527.1 480 544 463.1 544 442.2C544 435.5 542.2 428.9 538.9 423.2L517 385.7C498 353.1 488 316.1 488 278.4L488 263.9C488 179.3 425.4 109.2 344 97.6L344 87.9C344 74.6 333.3 63.9 320 63.9zM488.4 432L151.5 432L164.4 409.9C187.7 370 200 324.6 200 278.5L200 264C200 197.7 253.7 144 320 144C386.3 144 440 197.7 440 264L440 278.5C440 324.7 452.3 370 475.5 409.9L488.4 432zM252.1 528C262 556 288.7 576 320 576C351.3 576 378 556 387.9 528L252.1 528z"/></svg>';
    const repeatSvg = '<svg class="icon-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640"><path d="M544.1 256L552 256C565.3 256 576 245.3 576 232L576 88C576 78.3 570.2 69.5 561.2 65.8C552.2 62.1 541.9 64.2 535 71L483.3 122.8C439 86.1 382 64 320 64C191 64 84.3 159.4 66.6 283.5C64.1 301 76.2 317.2 93.7 319.7C111.2 322.2 127.4 310 129.9 292.6C143.2 199.5 223.3 128 320 128C364.4 128 405.2 143 437.7 168.3L391 215C384.1 221.9 382.1 232.2 385.8 241.2C389.5 250.2 398.3 256 408 256L544.1 256zM573.5 356.5C576 339 563.8 322.8 546.4 320.3C529 317.8 512.7 330 510.2 347.4C496.9 440.4 416.8 511.9 320.1 511.9C275.7 511.9 234.9 496.9 202.4 471.6L249 425C255.9 418.1 257.9 407.8 254.2 398.8C250.5 389.8 241.7 384 232 384L88 384C74.7 384 64 394.7 64 408L64 552C64 561.7 69.8 570.5 78.8 574.2C87.8 577.9 98.1 575.8 105 569L156.8 517.2C201 553.9 258 576 320 576C449 576 555.7 480.6 573.4 356.5z"/></svg>';

    function persistSortPrefs() {
      requestAction('SetSortPrefs', JSON.stringify({ mode: sortMode, dir: sortDir }));
    }

    function applyUiVisibility() {
      const showOverview = state.showOverview !== false;
      const showCreateButton = state.showCreateButton !== false;
      const showSorting = state.showSorting !== false;

      const stats = document.querySelector('.stats');
      if (stats) stats.style.display = showOverview ? '' : 'none';

      const newBtn = document.getElementById('newBtn');
      if (newBtn) newBtn.style.display = showCreateButton ? '' : 'none';

      const toolbar = document.querySelector('.toolbar');
      if (toolbar) toolbar.style.display = showSorting ? '' : 'none';
    }

    function setManualSort() {
      sortMode = 'manual';
      const sel = document.getElementById('sortSelect');
      if (sel) sel.value = 'manual';
      updateSortButtons();
      persistSortPrefs();
    }

    function initTexts() {
      document.getElementById('formTitle').textContent = translate('New Task');
      document.getElementById('addBtn').textContent = translate('Add');
      document.getElementById('deleteBtnText').textContent = translate('Delete');

      document.getElementById('statOpenLabel').textContent = translate('Open Tasks');
      document.getElementById('statOverdueLabel').textContent = translate('Overdue');
      document.getElementById('statTodayLabel').textContent = translate('Due Today');

      document.getElementById('title').title = translate('Title');
      document.getElementById('title').placeholder = translate('Title');
      document.getElementById('info').title = translate('Info');
      document.getElementById('info').placeholder = translate('Info');
      document.getElementById('quantity').title = translate('Quantity');
      document.getElementById('quantity').placeholder = translate('Quantity');
      document.getElementById('recurrenceCustomUnit').title = translate('Unit');
      document.getElementById('recurrenceCustomValue').title = translate('Interval');
      document.getElementById('recurrenceCustomValue').placeholder = translate('Interval');
      document.getElementById('due').title = translate('Due');
      document.getElementById('duePlaceholder').textContent = translate('Due placeholder');
      document.getElementById('notificationFieldLabel').textContent = translate('Notification');

      document.getElementById('recurrenceFieldLabel').textContent = translate('Repeat');
      document.getElementById('recurrenceResetFieldLabel').textContent = translate('Reopen');
      const rec = document.getElementById('recurrence');
      rec.innerHTML = '';
      const recOpts = [
        { v: 'none', t: 'No repeat' },
        { v: 'custom', t: 'Custom' },
        { v: 'w1', t: 'Every week' },
        { v: 'w2', t: 'Every 2 weeks' },
        { v: 'w3', t: 'Every 3 weeks' },
        { v: 'm1', t: 'Monthly' },
        { v: 'q1', t: 'Quarterly' },
        { v: 'y1', t: 'Yearly' }
      ];
      for (const o of recOpts) {
        const el = document.createElement('option');
        el.value = o.v;
        el.textContent = translate(o.t);
        rec.appendChild(el);
      }
      rec.value = 'none';

      const cu = document.getElementById('recurrenceCustomUnit');
      cu.innerHTML = '';
      const cuOpts = [
        { v: 'h', t: 'Hours' },
        { v: 'd', t: 'Days' },
        { v: 'w', t: 'Weeks' },
        { v: 'm', t: 'Months' },
        { v: 'y', t: 'Years' }
      ];
      for (const o of cuOpts) {
        const el = document.createElement('option');
        el.value = o.v;
        el.textContent = translate(o.t);
        cu.appendChild(el);
      }
      cu.value = 'w';
      document.getElementById('recurrenceCustomValue').value = '1';

      const rrl = document.getElementById('recurrenceResetLeadTime');
      rrl.innerHTML = '';
      const reopenOpts = [
        { v: 0, t: 'Disabled' },
        { v: -1, t: 'Immediate' },
        { v: 1800, t: '30 minutes' },
        { v: 3600, t: '1 hour' },
        { v: 21600, t: '6 hours' },
        { v: 43200, t: '12 hours' },
        { v: 86400, t: '1 day before' },
        { v: 172800, t: '2 days before' },
        { v: 259200, t: '3 days before' },
        { v: 604800, t: '1 week before' },
        { v: 1209600, t: '2 weeks before' },
        { v: 2592000, t: '1 month before' }
      ];
      for (const o of reopenOpts) {
        const el = document.createElement('option');
        el.value = String(o.v);
        el.textContent = translate(o.t);
        rrl.appendChild(el);
      }
      rrl.value = '259200';

      document.getElementById('sortLabel').textContent = translate('Sort');
      const sort = document.getElementById('sortSelect');
      sort.innerHTML = '';
      const sortOpts = [
        { v: 'manual', t: 'Sort by manual' },
        { v: 'created', t: 'Sort by creation' },
        { v: 'due', t: 'Sort by due' },
        { v: 'priority', t: 'Sort by priority' },
        { v: 'title', t: 'Sort by title' }
      ];
      for (const o of sortOpts) {
        const el = document.createElement('option');
        el.value = o.v;
        el.textContent = translate(o.t);
        sort.appendChild(el);
      }
      sort.value = sortMode;

      document.getElementById('sortAsc').title = translate('Ascending');
      document.getElementById('sortDesc').title = translate('Descending');

      const lt = document.getElementById('notificationLeadTime');
      lt.innerHTML = '';
      const opts = [
        { v: 0, t: '0 minutes' },
        { v: 300, t: '5 minutes' },
        { v: 600, t: '10 minutes' },
        { v: 1800, t: '30 minutes' },
        { v: 3600, t: '1 hour' },
        { v: 18000, t: '5 hours' },
        { v: 43200, t: '12 hours' }
      ];
      for (const o of opts) {
        const el = document.createElement('option');
        el.value = String(o.v);
        el.textContent = translate(o.t);
        lt.appendChild(el);
      }

      const prio = document.getElementById('prio');
      prio.querySelector('option[value="low"]').textContent = translate('Priority low');
      prio.querySelector('option[value="normal"]').textContent = translate('Priority normal');
      prio.querySelector('option[value="high"]').textContent = translate('Priority high');

      document.getElementById('newBtn').textContent = translate('New Task');
      document.getElementById('cancelBtn').textContent = translate('Cancel');

      document.getElementById('detailHeader').textContent = translate('Details');
      document.getElementById('detailCloseBtn').textContent = translate('Close');
    }

    function updateSortButtons() {
      const asc = document.getElementById('sortAsc');
      const desc = document.getElementById('sortDesc');
      const toolbar = document.querySelector('.toolbar');
      if (toolbar) toolbar.classList.toggle('manual-sort', sortMode === 'manual');
      if (sortMode === 'manual') {
        if (asc) {
          asc.disabled = true;
          asc.classList.remove('active');
        }
        if (desc) {
          desc.disabled = true;
          desc.classList.remove('active');
        }
        return;
      }
      if (asc) asc.classList.toggle('active', sortDir === 'asc');
      if (desc) desc.classList.toggle('active', sortDir === 'desc');
      if (asc) asc.disabled = false;
      if (desc) desc.disabled = false;
    }

    function sortItems(items) {
      const list = Array.isArray(items) ? items.slice() : [];

      if (sortMode === 'manual') {
        return list;
      }

      const compareDue = (a, b) => {
        const da = parseInt(a.due) || 0;
        const db = parseInt(b.due) || 0;
        if (da <= 0 && db <= 0) return 0;
        if (da <= 0) return 1;
        if (db <= 0) return -1;
        return sortDir === 'asc' ? (da - db) : (db - da);
      };

      const prioRankLowFirst = (p) => {
        const v = String(p ?? 'normal');
        if (v === 'low') return 0;
        if (v === 'normal') return 1;
        return 2;
      };

      const getCreatedKey = (it) => parseInt(it.createdAt) || 0;
      const getTitleKey = (it) => String(it.title ?? '');
      const getIdKey = (it) => parseInt(it.id) || 0;

      list.sort((a, b) => {
        if (sortMode === 'due') {
          const c = compareDue(a, b);
          if (c !== 0) return c;
          return getIdKey(a) - getIdKey(b);
        }
        if (sortMode === 'priority') {
          const pa = prioRankLowFirst(a.priority);
          const pb = prioRankLowFirst(b.priority);
          if (pa !== pb) {
            return sortDir === 'asc' ? (pa - pb) : (pb - pa);
          }
          const c = compareDue(a, b);
          if (c !== 0) return c;
          return getIdKey(a) - getIdKey(b);
        }
        if (sortMode === 'title') {
          const ta = getTitleKey(a);
          const tb = getTitleKey(b);
          const c = ta.localeCompare(tb, undefined, { sensitivity: 'base' });
          if (c !== 0) return c;
          return getIdKey(a) - getIdKey(b);
        }
        const ca = getCreatedKey(a);
        const cb = getCreatedKey(b);
        if (ca !== cb) return sortDir === 'asc' ? (ca - cb) : (cb - ca);
        return getIdKey(a) - getIdKey(b);
      });

      if (sortMode === 'title' && sortDir === 'desc') {
        list.reverse();
      }
      return list;
    }

    function openOverlay(mode) {
      const overlay = document.getElementById('overlay');
      const title = document.getElementById('formTitle');
      const submit = document.getElementById('addBtn');
      const delBtn = document.getElementById('deleteBtn');

      if (mode === 'edit') {
        title.textContent = translate('Edit Task');
        submit.textContent = translate('Save');
        if (delBtn) delBtn.style.display = '';
      } else {
        title.textContent = translate('New Task');
        submit.textContent = translate('Add');
        if (delBtn) delBtn.style.display = 'none';
      }

      overlay.classList.add('open');
      document.getElementById('title').focus();
    }

    function closeOverlay() {
      document.getElementById('overlay').classList.remove('open');
      editingId = 0;
    }

    function openDetail(id) {
      const it = (Array.isArray(state.items) ? state.items : []).find(x => parseInt(x.id) === parseInt(id));
      if (!it) return;

      document.getElementById('detailTaskTitle').textContent = String(it.title ?? '');
      document.getElementById('detailTaskInfo').textContent = String(it.info ?? '');

      const dueTs = parseInt(it.due) || 0;
      const due = formatDue(dueTs);
      const dueClass = getDueBadgeClass(dueTs);
      const quantity = parseInt(it.quantity) || 0;
      const notification = !!it.notification;
      const recurrence = String(it.recurrence ?? 'none');
      const recurrenceCustomUnit = String(it.recurrenceCustomUnit ?? 'w');
      const recurrenceCustomValue = parseInt(it.recurrenceCustomValue) || 1;
      const prio = String(it.priority ?? 'normal');
      const prioKey = getPriorityKey(prio);
      const prioLabel = getPriorityLabel(prioKey);
      const showInfoBadges = state.showInfoBadges === true;

      const meta = [];
      if (quantity > 0) meta.push(`<span class="badge quantity">${quantity}Ã—</span>`);
      if (showInfoBadges && due) meta.push(`<span class="badge due-badge ${dueClass}" title="${escapeHtml(due)}"><i class="fa-light fa-calendar due-icon"></i><span class="due-text">${escapeHtml(due)}</span></span>`);
      if (showInfoBadges && notification) meta.push(`<span class="badge notify-badge" title="${escapeHtml(translate('Notification'))}">${bellSvg}</span>`);
      if (showInfoBadges && recurrence !== 'none') meta.push(`<span class="badge recur-badge" title="${escapeHtml(getRecurrenceTooltip(recurrence, dueTs, recurrenceCustomUnit, recurrenceCustomValue))}">${repeatSvg}</span>`);
      if (showInfoBadges) meta.push(`<span class="badge ${prioKey}">${escapeHtml(prioLabel)}</span>`);
      document.getElementById('detailMeta').innerHTML = meta.join('');

      document.getElementById('detailOverlay').classList.add('open');
    }

    function closeDetail() {
      document.getElementById('detailOverlay').classList.remove('open');
    }

    function getDefaultNotificationLeadTime() {
      const v = parseInt(state.notificationLeadTimeDefault);
      return Number.isFinite(v) ? v : 600;
    }

    function updateNotificationLeadTimeInfo() {
      const chk = document.getElementById('notification');
      const sel = document.getElementById('notificationLeadTime');
      const info = document.getElementById('notificationLeadTimeInfo');
      const show = !chk.disabled && chk.checked;
      info.style.display = show ? '' : 'none';
      if (!show) {
        info.textContent = '';
        return;
      }
      const opt = sel.options[sel.selectedIndex];
      const text = opt ? opt.textContent : '';
      info.textContent = translate('Notify before due').replace('{0}', text);
    }

    function updateNotificationLeadTimeUI() {
      const chk = document.getElementById('notification');
      const sel = document.getElementById('notificationLeadTime');
      const enabled = !chk.disabled && chk.checked;
      sel.disabled = !enabled;
      sel.style.display = '';
      if (sel.value === '' || sel.value === null || typeof sel.value === 'undefined') {
        sel.value = String(getDefaultNotificationLeadTime());
      }
      updateNotificationLeadTimeValidity();
      updateNotificationLeadTimeInfo();
    }

    function updateNotificationLeadTimeValidity() {
      const dueTs = parseDueInputToTimestamp();
      const rec = document.getElementById('recurrence');
      const r = String((rec ? rec.value : 'none') || 'none');
      const chk = document.getElementById('notification');
      const sel = document.getElementById('notificationLeadTime');
      if (!sel) return;

      const active = dueTs > 0 && chk && !chk.disabled && chk.checked;
      if (!active) {
        for (const opt of Array.from(sel.options)) {
          opt.disabled = false;
        }
        return;
      }

      const nowTs = Math.floor(Date.now() / 1000);
      const untilDue = Math.max(0, dueTs - nowTs);
      let limit = untilDue;
      if (r !== 'none') {
        const interval = getRecurrenceIntervalSeconds();
        if (Number.isFinite(interval) && interval > 0) {
          limit = Math.min(limit, interval);
        }
      }

      const allowedValues = [];
      for (const opt of Array.from(sel.options)) {
        const v = parseInt(opt.value);
        if (!Number.isFinite(v)) {
          opt.disabled = false;
          continue;
        }
        if (v === 0) {
          opt.disabled = false;
          allowedValues.push(0);
          continue;
        }

        const ok = v < limit;
        opt.disabled = !ok;
        if (ok) allowedValues.push(v);
      }

      const current = parseInt(sel.value);
      const currentOk = Number.isFinite(current) && (current === 0 || current < limit);
      if (!currentOk) {
        const nonZeroAllowed = allowedValues.filter(x => x > 0).sort((a, b) => b - a);
        sel.value = nonZeroAllowed.length > 0 ? String(nonZeroAllowed[0]) : '0';
      }
    }

    function updateNotificationAvailability() {
      const dueStr = document.getElementById('due').value || '';
      const chk = document.getElementById('notification');
      const enabled = dueStr !== '';
      chk.disabled = !enabled;
      updateDuePlaceholder();
      if (!enabled) {
        chk.checked = false;
      }
      updateNotificationLeadTimeUI();
      updateRecurrenceAvailability();
    }

    function updateRecurrenceAvailability() {
      const dueStr = document.getElementById('due').value || '';
      const lbl = document.getElementById('recurrenceFieldLabel');
      const wrap = document.getElementById('recurrenceWrap');
      const sel = document.getElementById('recurrence');
      const enabled = dueStr !== '';
      if (lbl) lbl.style.display = enabled ? '' : 'none';
      if (wrap) wrap.style.display = enabled ? '' : 'none';
      if (!enabled && sel) {
        sel.value = 'none';
      }

      updateRecurrenceResetAvailability();
      updateRecurrenceCustomAvailability();
    }

    function updateRecurrenceResetAvailability() {
      const dueStr = document.getElementById('due').value || '';
      const rec = document.getElementById('recurrence');
      const rlbl = document.getElementById('recurrenceResetFieldLabel');
      const rwrap = document.getElementById('recurrenceResetWrap');
      const rsel = document.getElementById('recurrenceResetLeadTime');
      const enabled = dueStr !== '' && (rec ? (rec.value || 'none') : 'none') !== 'none';
      if (rlbl) rlbl.style.display = enabled ? '' : 'none';
      if (rwrap) rwrap.style.display = enabled ? '' : 'none';
      if (!enabled && rsel) {
        rsel.value = '0';
      }

      updateReopenLeadTimeValidity();
    }

    function updateRecurrenceCustomAvailability() {
      const dueStr = document.getElementById('due').value || '';
      const rec = document.getElementById('recurrence');
      const wrap = document.getElementById('recurrenceCustomWrap');
      const enabled = dueStr !== '' && (rec ? (rec.value || 'none') : 'none') === 'custom';
      if (wrap) wrap.style.display = enabled ? 'flex' : 'none';
      if (!enabled) {
        const cu = document.getElementById('recurrenceCustomUnit');
        const cv = document.getElementById('recurrenceCustomValue');
        if (cu) cu.value = 'w';
        if (cv) cv.value = '1';
      }

      updateReopenLeadTimeValidity();
    }

    function parseDueInputToTimestamp() {
      const dueStr = document.getElementById('due').value || '';
      if (dueStr === '') return 0;
      const d = new Date(dueStr);
      if (isNaN(d.getTime())) return 0;
      return Math.floor(d.getTime() / 1000);
    }

    function getDaysInMonth(year, monthIndex) {
      return new Date(year, monthIndex + 1, 0).getDate();
    }

    function addMonthsClamped(dateObj, monthsToAdd) {
      const d = new Date(dateObj.getTime());
      const day = d.getDate();
      const hour = d.getHours();
      const minute = d.getMinutes();
      const second = d.getSeconds();
      const ms = d.getMilliseconds();

      const y = d.getFullYear();
      const m = d.getMonth();
      const targetMonth = m + monthsToAdd;
      const ty = y + Math.floor(targetMonth / 12);
      const tm = ((targetMonth % 12) + 12) % 12;

      const maxDay = getDaysInMonth(ty, tm);
      const clampedDay = Math.min(day, maxDay);

      return new Date(ty, tm, clampedDay, hour, minute, second, ms);
    }

    function getRecurrenceIntervalSeconds() {
      const dueTs = parseDueInputToTimestamp();
      if (dueTs <= 0) return 0;

      const dueStr = document.getElementById('due').value || '';
      const dueDate = new Date(dueStr);
      if (isNaN(dueDate.getTime())) return 0;

      const rec = document.getElementById('recurrence');
      const r = String((rec ? rec.value : 'none') || 'none');
      if (r === 'none') return 0;

      if (r === 'w1') return 604800;
      if (r === 'w2') return 1209600;
      if (r === 'w3') return 1814400;

      if (r === 'm1') {
        const next = addMonthsClamped(dueDate, 1);
        return Math.floor((next.getTime() - dueDate.getTime()) / 1000);
      }
      if (r === 'q1') {
        const next = addMonthsClamped(dueDate, 3);
        return Math.floor((next.getTime() - dueDate.getTime()) / 1000);
      }
      if (r === 'y1') {
        const next = addMonthsClamped(dueDate, 12);
        return Math.floor((next.getTime() - dueDate.getTime()) / 1000);
      }

      if (r === 'custom') {
        const u = String(document.getElementById('recurrenceCustomUnit').value || 'w');
        const v = Math.max(1, parseInt(document.getElementById('recurrenceCustomValue').value) || 1);
        if (u === 'h') return 3600 * v;
        if (u === 'd') return 86400 * v;
        if (u === 'w') return 604800 * v;
        if (u === 'm') {
          const next = addMonthsClamped(dueDate, v);
          return Math.floor((next.getTime() - dueDate.getTime()) / 1000);
        }
        if (u === 'y') {
          const next = addMonthsClamped(dueDate, 12 * v);
          return Math.floor((next.getTime() - dueDate.getTime()) / 1000);
        }
      }

      return 0;
    }

    function updateReopenLeadTimeValidity() {
      const dueTs = parseDueInputToTimestamp();
      const rec = document.getElementById('recurrence');
      const r = String((rec ? rec.value : 'none') || 'none');
      const rsel = document.getElementById('recurrenceResetLeadTime');
      if (!rsel) return;

      const active = dueTs > 0 && r !== 'none';
      if (!active) {
        for (const opt of Array.from(rsel.options)) {
          opt.disabled = false;
        }
        return;
      }

      const interval = getRecurrenceIntervalSeconds();
      if (!Number.isFinite(interval) || interval <= 0) {
        for (const opt of Array.from(rsel.options)) {
          opt.disabled = false;
        }
        return;
      }

      const allowedValues = [];
      for (const opt of Array.from(rsel.options)) {
        const v = parseInt(opt.value);
        if (!Number.isFinite(v)) {
          opt.disabled = false;
          continue;
        }
        if (v === 0) {
          opt.disabled = false;
          allowedValues.push(0);
          continue;
        }
        if (v === -1) {
          opt.disabled = false;
          allowedValues.push(-1);
          continue;
        }
        const ok = v < interval;
        opt.disabled = !ok;
        if (ok) allowedValues.push(v);
      }

      const current = parseInt(rsel.value);
      const currentOk = Number.isFinite(current) && (current === -1 || current < interval);
      if (!currentOk) {
        const nonZeroAllowed = allowedValues.filter(x => x > 0).sort((a, b) => b - a);
        rsel.value = nonZeroAllowed.length > 0 ? String(nonZeroAllowed[0]) : '0';
      }
    }

    function updateDuePlaceholder() {
      const due = document.getElementById('due');
      const ph = document.getElementById('duePlaceholder');
      if (!due || !ph) {
        return;
      }
      const hasValue = (due.value || '') !== '';
      const isFocused = document.activeElement === due;
      const wrap = due.closest('.date-input');
      if (wrap) {
        wrap.classList.toggle('has-value', hasValue);
        wrap.classList.toggle('is-focused', isFocused);
      }
      ph.style.display = (!hasValue && !isFocused) ? '' : 'none';
    }

    function resetForm() {
      document.getElementById('title').value = '';
      document.getElementById('info').value = '';
      document.getElementById('quantity').value = '';
      document.getElementById('notification').checked = false;
      document.getElementById('notificationLeadTime').value = String(getDefaultNotificationLeadTime());
      document.getElementById('due').value = '';
      document.getElementById('prio').value = 'normal';
      document.getElementById('recurrence').value = 'none';
      document.getElementById('recurrenceResetLeadTime').value = '604800';
      document.getElementById('recurrenceCustomUnit').value = 'w';
      document.getElementById('recurrenceCustomValue').value = '1';
      updateNotificationAvailability();
    }

    function timestampToLocalInput(ts) {
      const t = parseInt(ts);
      if (!Number.isFinite(t) || t <= 0) return '';
      const d = new Date(t * 1000);
      if (isNaN(d.getTime())) return '';
      const pad = (n) => String(n).padStart(2, '0');
      return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }

    function openNew() {
      resetForm();
      editingId = 0;
      updateReopenLeadTimeValidity();
      updateNotificationLeadTimeValidity();
      openOverlay('new');
    }

    function openEdit(id) {
      const it = (Array.isArray(state.items) ? state.items : []).find(x => parseInt(x.id) === parseInt(id));
      if (!it) return;

      editingId = parseInt(it.id);
      document.getElementById('title').value = String(it.title ?? '');
      document.getElementById('info').value = String(it.info ?? '');
      document.getElementById('notification').checked = !!it.notification;
      {
        const lt = parseInt(it.notificationLeadTime);
        document.getElementById('notificationLeadTime').value = String(Number.isFinite(lt) ? lt : getDefaultNotificationLeadTime());
      }
      document.getElementById('prio').value = String(it.priority ?? 'normal');
      document.getElementById('due').value = timestampToLocalInput(it.due ?? 0);
      document.getElementById('recurrence').value = String(it.recurrence ?? 'none');
      document.getElementById('recurrenceCustomUnit').value = String(it.recurrenceCustomUnit ?? 'w');
      document.getElementById('recurrenceCustomValue').value = String(parseInt(it.recurrenceCustomValue) || 1);
      {
        const rrl = parseInt(it.recurrenceResetLeadTime);
        document.getElementById('recurrenceResetLeadTime').value = String(Number.isFinite(rrl) ? rrl : 604800);
      }
      document.getElementById('quantity').value = parseInt(it.quantity) || '';
      updateNotificationAvailability();
      updateReopenLeadTimeValidity();
      updateNotificationLeadTimeValidity();
      openOverlay('edit');
    }

    function renderItem(it) {
      const id = String(it.id);
      const title = escapeHtml(it.title ?? '');
      const info = escapeHtml(it.info ?? '');
      const done = !!it.done;
      const dueTs = parseInt(it.due) || 0;
      const due = formatDue(dueTs);
      const dueClass = getDueBadgeClass(dueTs);
      const rawQty = parseInt(it.quantity);
      const notification = !!it.notification;
      const recurrence = String(it.recurrence ?? 'none');
      const recurrenceCustomUnit = String(it.recurrenceCustomUnit ?? 'w');
      const recurrenceCustomValue = parseInt(it.recurrenceCustomValue) || 1;
      const prio = String(it.priority ?? 'normal');
      const prioKey = getPriorityKey(prio);
      const prioLabel = getPriorityLabel(prioKey);
      const group = done ? 'completed' : 'active';
      const showInfoBadges = state.showInfoBadges === true;
      const showDeleteButton = state.showDeleteButton !== false;
      const showEditButton = state.showEditButton !== false;
      const useGridView = state.useGridView === true;
      const showLargeQuantity = useGridView && state.showLargeQuantity === true;
      const shoppingMode = useGridView && state.gridShoppingListMode === true;

      const quantity = shoppingMode
        ? ((Number.isFinite(rawQty) && rawQty > 0) ? rawQty : 1)
        : ((Number.isFinite(rawQty) && rawQty > 0) ? rawQty : 0);

      const qtyLargeHtml = (!shoppingMode && useGridView && showLargeQuantity && quantity > 0)
        ? `<div class="quantity-large-wrap"><span class="badge quantity large-qty">${quantity}Ã—</span></div>`
        : '';

      const qtyShoppingHtml = (shoppingMode && quantity > 0)
        ? `<div class="shopping-qty-wrap"><span class="badge quantity${showLargeQuantity ? ' large-qty' : ''}">${quantity}Ã—</span></div>`
        : '';

      const meta = [];
      if (!shoppingMode && quantity > 0 && (!useGridView || !showLargeQuantity)) {
        meta.push(`<span class="badge quantity${showLargeQuantity ? ' large-qty' : ''}">${quantity}Ã—</span>`);
      }
      if (!shoppingMode && showInfoBadges && due) {
        meta.push(useGridView
          ? `<span class="badge due-badge ${dueClass} icon-only" title="${escapeHtml(due)}"><i class="fa-light fa-calendar"></i></span>`
          : `<span class="badge due-badge ${dueClass}" title="${escapeHtml(due)}"><i class="fa-light fa-calendar due-icon"></i><span class="due-text">${escapeHtml(due)}</span></span>`);
      }
      if (!shoppingMode && showInfoBadges && notification) {
        meta.push(`<span class="badge notify-badge${useGridView ? ' icon-only' : ''}" title="${escapeHtml(translate('Notification'))}">${bellSvg}</span>`);
      }
      if (!shoppingMode && showInfoBadges && recurrence !== 'none') {
        meta.push(`<span class="badge recur-badge${useGridView ? ' icon-only' : ''}" title="${escapeHtml(getRecurrenceTooltip(recurrence, dueTs, recurrenceCustomUnit, recurrenceCustomValue))}">${repeatSvg}</span>`);
      }
      if (!shoppingMode && showInfoBadges) {
        meta.push(useGridView
          ? `<span class="badge ${prioKey} icon-only" title="${escapeHtml(prioLabel)}"><i class="fa-light fa-star"></i></span>`
          : `<span class="badge ${prioKey}">${escapeHtml(prioLabel)}</span>`);
      }

      const actionButtons = `${showDeleteButton ? `<button class="del icon-btn" title="${translate('Delete')}" aria-label="${translate('Delete')}"><i class="fa-light fa-trash-can"></i></button>` : ''}
            ${showEditButton ? `<button class="edit icon-btn" title="${translate('Edit')}" aria-label="${translate('Edit')}"><i class="fa-light fa-pencil"></i></button>` : ''}
            <div class="drag-handle" draggable="true"><i class="fa-light fa-grip-dots-vertical"></i></div>`;

      const actionsHtml = useGridView
        ? `<div class="meta">${meta.join('')}</div><div class="grid-actions">${actionButtons}</div>`
        : `<div class="meta">${meta.join('')}</div>${actionButtons}`;

      return `
        <div class="item ${done ? 'done' : ''}" data-id="${id}" data-done="${done ? '1' : '0'}" data-group="${group}">
          <div class="main">
            <input type="checkbox" class="chk" ${done ? 'checked' : ''} />
            <div class="content">
              <div class="title">${title}</div>
              ${info ? `<div class="info">${info}</div>` : ''}
              ${shoppingMode ? qtyShoppingHtml : qtyLargeHtml}
            </div>
          </div>
          <div class="actions">
            ${actionsHtml}
          </div>
        </div>
      `;
    }

    function bindDnd(container) {
      if (!dndBound) {
        container.addEventListener('dragover', (e) => {
          if (!dragItem) return;
          e.preventDefault();

          const target = e.target.closest('.item');
          if (!target || target === dragItem) return;
          if ((target.getAttribute('data-group') || '') !== dragGroup) return;

          const rect = target.getBoundingClientRect();
          const after = (e.clientY - rect.top) > (rect.height / 2);

          container.querySelectorAll('.item.drag-over').forEach(x => x.classList.remove('drag-over'));
          target.classList.add('drag-over');

          if (after) {
            target.after(dragItem);
          } else {
            target.before(dragItem);
          }
        });

        container.addEventListener('drop', (e) => {
          if (!dragItem) return;
          e.preventDefault();

          container.querySelectorAll('.item.drag-over').forEach(x => x.classList.remove('drag-over'));

          const activeIds = Array.from(container.querySelectorAll('.item[data-group="active"]'))
            .map(el => parseInt(el.getAttribute('data-id')))
            .filter(n => Number.isFinite(n));
          let completedIds = Array.from(container.querySelectorAll('.item[data-group="completed"]'))
            .map(el => parseInt(el.getAttribute('data-id')))
            .filter(n => Number.isFinite(n));

          const hideCompleted = state.hideCompletedTasks === true;
          if (hideCompleted) {
            completedIds = (Array.isArray(state.items) ? state.items : [])
              .filter(it => !!it.done)
              .map(it => parseInt(it.id))
              .filter(n => Number.isFinite(n));
          }

          setManualSort();
          requestAction('Reorder', JSON.stringify({ order: activeIds.concat(completedIds) }));
        });

        dndBound = true;
      }

      container.querySelectorAll('.drag-handle').forEach(handle => {
        handle.addEventListener('dragstart', (e) => {
          const item = handle.closest('.item');
          if (!item) return;
          dragItem = item;
          dragGroup = item.getAttribute('data-group') || '';
          item.classList.add('dragging');

          if (e.dataTransfer) {
            e.dataTransfer.effectAllowed = 'move';
            try {
              e.dataTransfer.setData('text/plain', item.getAttribute('data-id') || '');
            } catch (err) {
            }
            const ghost = document.createElement('div');
            ghost.style.width = '1px';
            ghost.style.height = '1px';
            ghost.style.opacity = '0.01';
            document.body.appendChild(ghost);
            e.dataTransfer.setDragImage(ghost, 0, 0);
            setTimeout(() => ghost.remove(), 0);
          }
        });

        handle.addEventListener('dragend', () => {
          if (dragItem) {
            dragItem.classList.remove('dragging');
          }
          container.querySelectorAll('.item.drag-over').forEach(x => x.classList.remove('drag-over'));
          dragItem = null;
          dragGroup = '';
        });
      });
    }

    function updateStats() {
      const items = Array.isArray(state.items) ? state.items : [];
      const now = new Date();
      const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime() / 1000;
      const todayEnd = todayStart + 86400;

      let open = 0, overdue = 0, today = 0;
      items.forEach(it => {
        if (it.done) return;
        open++;
        const due = parseInt(it.due) || 0;
        if (due > 0) {
          if (due < todayStart) overdue++;
          else if (due >= todayStart && due < todayEnd) today++;
        }
      });

      document.getElementById('statOpenValue').textContent = open;
      document.getElementById('statOverdueValue').textContent = overdue;
      document.getElementById('statTodayValue').textContent = today;
    }

    function render() {
      updateStats();
      const container = document.getElementById('list');
      const items = Array.isArray(state.items) ? state.items : [];
      const hideCompleted = state.hideCompletedTasks === true;

      container.classList.toggle('grid', state.useGridView === true);
      container.classList.toggle('shopping', state.useGridView === true && state.gridShoppingListMode === true);

      if (items.length === 0) {
        container.innerHTML = `<div class="empty">${translate('No items')}</div>`;
        bindDnd(container);
        return;
      }

      const active = sortItems(items.filter(it => !it.done));
      const completed = hideCompleted ? [] : sortItems(items.filter(it => !!it.done));

      let html = active.map(renderItem).join('');

      if (completed.length > 0) {
        html += `<div class="section-header">${translate('Completed')}</div>`;
        html += completed.map(renderItem).join('');
      }

      container.innerHTML = html;

      const shoppingMode = state.useGridView === true && state.gridShoppingListMode === true;

      container.querySelectorAll('.item').forEach(el => {
        const id = parseInt(el.getAttribute('data-id'));
        const chk = el.querySelector('.chk');
        const del = el.querySelector('.del');
        const edit = el.querySelector('.edit');
        const title = el.querySelector('.title');
        const info = el.querySelector('.info');
        const handle = el.querySelector('.drag-handle');

        if (!shoppingMode) {
          chk.addEventListener('change', () => {
            requestAction('ToggleDone', JSON.stringify({ id: id, done: chk.checked }));
          });
        }

        if (del) {
          del.addEventListener('click', (e) => {
            e.stopPropagation();
            requestAction('DeleteItem', JSON.stringify({ id: id }));
          });
        }

        if (edit) {
          edit.addEventListener('click', (e) => {
            e.stopPropagation();
            openEdit(id);
          });
        }

        if (!shoppingMode && title) {
          title.addEventListener('click', (e) => {
            e.stopPropagation();
            openDetail(id);
          });
        }

        if (!shoppingMode && info) {
          info.addEventListener('click', (e) => {
            e.stopPropagation();
            openDetail(id);
          });
        }

        if (shoppingMode) {
          el.addEventListener('click', () => {
            const currentDone = (el.getAttribute('data-done') || '0') === '1';
            requestAction('ToggleDone', JSON.stringify({ id: id, done: !currentDone }));
          });
        }

        if (handle) {
          handle.addEventListener('click', (e) => e.stopPropagation());
        }
      });

      bindDnd(container);
    }

    function handleMessage(data) {
      if (typeof data === 'string') {
        try {
          data = JSON.parse(data);
        } catch (e) {
          return;
        }
      }
      if (data && typeof data === 'object' && data.type === 'state') {
        if (typeof data.sortMode === 'string') {
          sortMode = data.sortMode;
        }
        if (typeof data.sortDir === 'string') {
          sortDir = data.sortDir;
        }
        const sel = document.getElementById('sortSelect');
        if (sel) sel.value = sortMode;
        updateSortButtons();

        const ov = parseInt(data.orderVersion) || 0;
        if (lastOrderVersion === null) {
          lastOrderVersion = ov;
        } else if (ov !== lastOrderVersion) {
          setManualSort();
          lastOrderVersion = ov;
        }
        state = data;
        applyUiVisibility();
        render();
      }
    }

    window.handleMessage = handleMessage;
    window.updateState = handleMessage;

    window.addEventListener('message', (event) => {
      if (!event) return;
      handleMessage(event.data);
    });

    function requestState() {
      requestAction('GetState', 0);
    }

    function getPriorityLabel(prio) {
      switch (String(prio)) {
        case 'low':
          return translate('Low');
        case 'high':
          return translate('High');
        default:
          return translate('Normal');
      }
    }

    function getPriorityKey(prio) {
      switch (String(prio)) {
        case 'low':
          return 'low';
        case 'high':
          return 'high';
        default:
          return 'normal';
      }
    }

    function getRecurrenceLabel(r, unit, val) {
      if (String(r) === 'custom') {
        const u = String(unit || 'w');
        const v = parseInt(val) || 1;
        const unitLabel = (() => {
          switch (u) {
            case 'h': return translate('Hours');
            case 'd': return translate('Days');
            case 'm': return translate('Months');
            case 'y': return translate('Years');
            default: return translate('Weeks');
          }
        })();
        return `${translate('Custom')}: ${v} ${unitLabel}`;
      }

      switch (String(r)) {
        case 'w1':
          return translate('Every week');
        case 'w2':
          return translate('Every 2 weeks');
        case 'w3':
          return translate('Every 3 weeks');
        case 'm1':
          return translate('Monthly');
        case 'q1':
          return translate('Quarterly');
        case 'y1':
          return translate('Yearly');
        default:
          return translate('No repeat');
      }
    }

    function getRecurrenceTooltip(r, dueTs, unit, val) {
      const label = getRecurrenceLabel(r, unit, val);
      const t = parseInt(dueTs) || 0;
      if (t <= 0) {
        return label;
      }
      const d = new Date(t * 1000);
      if (isNaN(d.getTime())) {
        return label;
      }

      switch (String(r)) {
        case 'custom':
        case 'w1':
        case 'w2':
        case 'w3': {
          const weekday = d.toLocaleDateString(undefined, { weekday: 'long' });
          return `${label} (${weekday})`;
        }
        case 'm1':
        case 'q1': {
          const day = d.getDate();
          return `${label} (${day}.)`;
        }
        case 'y1': {
          const date = d.toLocaleDateString(undefined, { month: '2-digit', day: '2-digit' });
          return `${label} (${date})`;
        }
        default:
          return label;
      }
    }

    function formatDue(ts) {
      const t = parseInt(ts);
      if (!Number.isFinite(t) || t <= 0) return '';
      const d = new Date(t * 1000);
      const date = d.toLocaleDateString(undefined, { year: 'numeric', month: '2-digit', day: '2-digit' });
      const time = d.toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit' });
      return `${date} ${time}`;
    }

    function getDueBadgeClass(ts) {
      const t = parseInt(ts);
      if (!Number.isFinite(t) || t <= 0) return '';

      const now = new Date();
      const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime() / 1000;
      const todayEnd = todayStart + 86400;

      if (t < todayStart) return 'due-overdue';
      if (t >= todayStart && t < todayEnd) return 'due-today';
      return '';
    }

    function escapeHtml(s) {
      return String(s)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#039;');
    }

    document.addEventListener('DOMContentLoaded', () => {
      initTexts();
      applyUiVisibility();

      document.getElementById('sortSelect').addEventListener('change', () => {
        sortMode = document.getElementById('sortSelect').value || 'created';
        updateSortButtons();
        persistSortPrefs();
        render();
      });
      document.getElementById('sortAsc').addEventListener('click', () => {
        if (sortMode === 'manual') return;
        sortDir = 'asc';
        updateSortButtons();
        persistSortPrefs();
        render();
      });
      document.getElementById('sortDesc').addEventListener('click', () => {
        if (sortMode === 'manual') return;
        sortDir = 'desc';
        updateSortButtons();
        persistSortPrefs();
        render();
      });
      updateSortButtons();

      document.getElementById('due').addEventListener('input', updateNotificationAvailability);
      document.getElementById('due').addEventListener('change', updateNotificationAvailability);
      document.getElementById('due').addEventListener('focus', updateDuePlaceholder);
      document.getElementById('due').addEventListener('blur', updateDuePlaceholder);
      document.getElementById('notification').addEventListener('change', updateNotificationLeadTimeUI);
      document.getElementById('recurrence').addEventListener('change', () => {
        updateRecurrenceResetAvailability();
        updateRecurrenceCustomAvailability();
        updateNotificationLeadTimeValidity();
      });
      document.getElementById('recurrenceCustomUnit').addEventListener('change', updateReopenLeadTimeValidity);
      document.getElementById('recurrenceCustomValue').addEventListener('input', updateReopenLeadTimeValidity);
      document.getElementById('recurrenceCustomValue').addEventListener('change', updateReopenLeadTimeValidity);
      document.getElementById('recurrenceCustomUnit').addEventListener('change', updateNotificationLeadTimeValidity);
      document.getElementById('recurrenceCustomValue').addEventListener('input', updateNotificationLeadTimeValidity);
      document.getElementById('recurrenceCustomValue').addEventListener('change', updateNotificationLeadTimeValidity);
      document.getElementById('notificationLeadTime').addEventListener('click', (e) => e.stopPropagation());
      document.getElementById('notificationLeadTime').addEventListener('change', updateNotificationLeadTimeInfo);
      updateNotificationAvailability();

      render();

      document.getElementById('newBtn').addEventListener('click', () => {
        openNew();
      });

      document.getElementById('cancelBtn').addEventListener('click', () => {
        closeOverlay();
      });

      document.getElementById('deleteBtn').addEventListener('click', () => {
        if (editingId > 0) {
          requestAction('DeleteItem', JSON.stringify({ id: editingId }));
        }
        closeOverlay();
      });

      document.getElementById('detailCloseBtn').addEventListener('click', () => {
        closeDetail();
      });

      document.getElementById('addBtn').addEventListener('click', () => {
        const title = (document.getElementById('title').value || '').trim();
        const info = (document.getElementById('info').value || '').trim();
        const notification = !!document.getElementById('notification').checked;
        const notificationLeadTime = (() => {
          const lt = parseInt(document.getElementById('notificationLeadTime').value);
          return Number.isFinite(lt) ? lt : getDefaultNotificationLeadTime();
        })();
        const dueStr = document.getElementById('due').value || '';
        const prio = document.getElementById('prio').value || 'normal';
        const quantity = parseInt(document.getElementById('quantity').value) || 0;
        const recurrence = (dueStr !== '') ? (document.getElementById('recurrence').value || 'none') : 'none';
        const recurrenceCustomUnit = (recurrence === 'custom') ? (document.getElementById('recurrenceCustomUnit').value || 'w') : 'w';
        const recurrenceCustomValue = (recurrence === 'custom') ? (parseInt(document.getElementById('recurrenceCustomValue').value) || 1) : 1;
        const recurrenceResetLeadTime = (dueStr !== '' && recurrence !== 'none')
          ? (() => {
              const v = parseInt(document.getElementById('recurrenceResetLeadTime').value);
              return Number.isFinite(v) ? v : 604800;
            })()
          : 0;

        if (title === '') return;

        let due = 0;
        if (dueStr) {
          const d = new Date(dueStr);
          if (!isNaN(d.getTime())) {
            due = Math.floor(d.getTime() / 1000);
          }
        }

        resetForm();

        if (editingId > 0) {
          requestAction('UpdateItem', JSON.stringify({ id: editingId, title, info, due, recurrence, recurrenceCustomUnit, recurrenceCustomValue, recurrenceResetLeadTime, priority: prio, quantity, notification, notificationLeadTime }));
        } else {
          requestAction('AddItem', JSON.stringify({ title, info, due, recurrence, recurrenceCustomUnit, recurrenceCustomValue, recurrenceResetLeadTime, priority: prio, quantity, notification, notificationLeadTime }));
        }
        closeOverlay();
      });

      requestState();
    });

    })();
  </script>
</body>
</html>
