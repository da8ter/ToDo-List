<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <script src="/icons.js"></script>
  <style>
    :root {
      --bg: var(--card-color);
      --card: var(--card-color);
      --text: var(--content-color,);
      --muted: color-mix(in srgb, var(--content-color) 30%, transparent);
      --border: color-mix(in srgb, var(--accent-color) 30%, transparent);
      --accent: var(--accent-color);
      --radius: 14px;
      --gap: 12px;
    }

    body {
      color: var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: transparent;
    }
    .wrap {
      position: relative;
      height: 100%;
      min-height: 0;
      padding: 0;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      gap: var(--gap);
      overflow: hidden;
    }
    .add {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }
    .add .full { grid-column: 1 / -1; }

    .overlay {
      position: absolute;
      inset: 0;
      padding: 0;
      box-sizing: border-box;
      display: none;
      flex-direction: column;
      gap: var(--gap);
      overflow: auto;
      scrollbar-width: none;
      align-items: stretch;
      justify-content: flex-start;
      z-index: 1000;
    }
    .overlay::-webkit-scrollbar { display: none; }
    #overlay {
      background: var(--bg);
      backdrop-filter: none;
    }
    #detailOverlay {
      background: var(--bg);
      backdrop-filter: none;
    }
    .overlay.open { display: flex; }
    .overlay-card {
      background: var(--card);
      border: 0px solid var(--border);
      border-radius: 0;
      display: flex;
      flex-direction: column;
      width: 100%;
      max-height: 100%;
      overflow: hidden;
    }
    .overlay-card::-webkit-scrollbar { display: none; }
    .overlay-body {
      display: flex;
      flex-direction: column;
      gap: 10px;
      flex: 1 1 auto;
      min-height: 0;
      overflow: auto;
      scrollbar-width: none;
      padding: var(--gap);
    }
    .overlay-body::-webkit-scrollbar { display: none; }
    .detail-card {
      max-height: 100%;
      overflow: hidden;
    }
    .detail-title {
      font-weight: 700;
      font-size: 16px;
      overflow-wrap: anywhere;
    }
    .detail-info {
      color: var(--text );
      font-size: 13px;
      white-space: pre-wrap;
      overflow-wrap: anywhere;
    }
    .detail-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
    }
    .overlay-title {
      font-weight: 700;
    }
    .overlay-actions {
      display: flex;
      gap: 8px;
      background: var(--card);
      padding: 10px var(--gap) var(--gap);
      border-top: 1px solid var(--border);
      border-radius: 0 0 var(--radius) var(--radius);
      flex: 0 0 auto;
    }
    .overlay-actions button { flex: 1; }
    .checkrow {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      font-size: 13px;
      user-select: none;
    }
    .checkrow label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      flex: 0 0 auto;
    }
    .hint {
      font-size: 12px;
      color: var(--muted);
      line-height: 1.2;
    }
    .field-label {
      font-size: 12px;
      font-weight: 600;
      color: var(--muted);
      margin-top: 2px;
      margin-bottom: -6px;
    }
    .checkrow select {
      flex: 1 1 auto;
      min-width: 0;
    }
    .checkrow .select-wrap {
      flex: 1 1 auto;
      min-width: 0;
    }
    .checkrow input[type="checkbox"] {
      width: 18px;
      height: 18px;
      margin: 0;
      padding: 0;
      flex: 0 0 auto;
    }
    .date-input {
      position: relative;
      width: 100%;
      color: var(--text);
    }
    .date-input input {
      padding-right: 40px;
      position: relative;
      z-index: 1;
    }
    .date-input:not(.has-value):not(.is-focused) input {
      color: transparent;
    }
    .date-input .date-placeholder {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      pointer-events: none;
      color: var(--muted);
      font-size: 13px;
      z-index: 2;
    }
    .date-input .cal-icon {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      pointer-events: none;
      color: inherit;
      z-index: 3;
    }
    #due::-webkit-calendar-picker-indicator { opacity: 0; }
    input:not([type="checkbox"]), select {
      width: 100%;
      box-sizing: border-box;
      border-radius: 10px;
      border: 1px solid var(--border);
      padding: 10px 12px;
      background: var(--bg);
      color: var(--text);
      outline: none;
    }
    button {
      border-radius: 10px;
      border: 1px solid var(--border);
      padding: 10px 12px;
      background: var(--card);
      color: var(--text);
      cursor: pointer;
      transition: transform .04s ease, border-color .12s ease;
      white-space: nowrap;
    }
    button:active { transform: scale(.98); }
    button.primary { border-color: var(--accent); background-color: var(--accent); }
    button.danger { border-color: rgb(255, 0, 0); background-color: rgb(255, 0, 0); }

    .list {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 8px;
      overflow: auto;
      scrollbar-width: none;
    }
    .list::-webkit-scrollbar { display: none; }

    .list.grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      grid-auto-rows: min-content;
      align-content: start;
      gap: 8px;
    }
    .list.grid.shopping {
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 6px;
    }
    .list.grid .section-header { grid-column: 1 / -1; }
    .list.grid .item {
      flex-direction: column;
      align-items: center;
      justify-content: space-between;
      text-align: center;
      aspect-ratio: 1 / 1;
      overflow: hidden;
      min-height: 0;
    }
    .list.grid.shopping .item { padding: calc(var(--gap) / 2); }
    .list.grid .item .main {
      flex-direction: column;
      align-items: center;
      width: 100%;
      flex: 1 1 auto;
      min-height: 0;
      overflow: auto;
      scrollbar-width: none;
    }
    .list.grid .item .main::-webkit-scrollbar { display: none; }
    .list.grid.shopping .item .main { overflow: hidden; }
    .list.grid.shopping .chk { display: none; }
    .list.grid .item .content {
      width: 100%;
      flex: 0 0 auto;
      min-height: 0;
      overflow: visible;
    }
    .list.grid.shopping .item .content {
      display: flex;
      flex-direction: column;
      flex: 1 1 auto;
      min-height: 0;
    }
    .list.grid.shopping .title {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .list.grid.shopping .info {
      display: block;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .list.grid.shopping .shopping-qty-wrap {
      flex: 1 1 auto;
      min-height: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
    }
    .list.grid .item .actions {
      width: 100%;
      margin-left: 0;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    .list.grid .title { font-size: 1.5em; }
    .list.grid.shopping .title { font-size: 1.05em; }
    .list.grid .item .meta {
      justify-content: center;
      flex-wrap: wrap;
    }
    .list.grid .item .grid-actions {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: calc(var(--gap) / 2);
      width: 100%;
    }
    .badge.icon-only {
      width: 24px;
      height: 24px;
      padding: 0;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    .list.grid .badge.quantity:not(.large-qty) {
      height: 24px;
      padding: 0 8px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      box-sizing: border-box;
    }
    .badge.quantity.large-qty {
      font-size: 25px;
      line-height: 1;
      padding: 8px 14px;
      font-weight: 800;
    }
    .quantity-large-wrap {
      display: flex;
      justify-content: center;
      width: 100%;
      margin-top: calc(var(--gap) / 2);
    }
    .list.grid .quantity-large-wrap { margin-top: var(--gap); }

    .item {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: var(--gap);
      padding: var(--gap);
      border-radius: var(--radius);
      background: var(--card);
      border: 1px solid var(--border);
    }
    .item .main {
      display: flex;
      align-items: center;
      gap: var(--gap);
      flex: 1 1 200px;
      min-width: 0;
    }
    .item .actions {
      display: flex;
      align-items: center;
      gap: calc(var(--gap) / 2);
      flex-shrink: 0;
      margin-left: auto;
    }
    .item .chk {
      flex-shrink: 0;
      width: 18px;
      height: 18px;
      margin: 0;
    }
    .item .content {
      flex: 1;
      min-width: 0;
    }
    .title {
      font-weight: 700;
      font-size: 1em;
      line-height: 1.2;
      white-space: normal;
      overflow: visible;
      text-overflow: clip;
      word-break: break-word;
    }
    .info {
      color: var(--text);
      font-size: 12px;
      white-space: normal;
      overflow: visible;
      text-overflow: clip;
      line-height: 1.35;
      margin-top: calc(var(--gap) / 2);
      display: -webkit-box;
      -webkit-line-clamp: 2;
      line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    .item .meta {
      flex-shrink: 0;
      display: flex;
      gap: 6px;
      align-items: center;
    }
    .badge {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      color: var(--muted);
    }
    .badge.due-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .badge.due-badge .due-icon { color: inherit; }
    .badge.due-badge .due-icon { display: none; }
    .badge.due-badge.due-overdue { border-color: rgb(255, 0, 0); color: var(--text); background-color: rgb(255, 0, 0, 0.2); }
    .badge.due-badge.due-today { border-color: #ffa500; color: var(--text); background-color: rgb(255, 165, 0, 0.2); }
    .badge.notify-badge { border-color: var(--accent); color: var(--text); background-color: color-mix(in srgb, var(--accent) 20%, var(--bg)); }
    @media (max-width: 420px) {
      .badge.due-badge .due-text { display: none; }
      .badge.due-badge .due-icon { display: inline-block; }
    }
    .badge.high, .badge.normal, .badge.low {
      display: inline-flex;
      justify-content: center;
      min-width: 60px;
    }
    .badge.icon-only.high,
    .badge.icon-only.normal,
    .badge.icon-only.low {
      min-width: 24px;
    }
    .badge.high { border-color: rgb(255, 0, 0); color: var(--text); background-color: rgb(255, 0, 0, 0.2);}
    .badge.low { border-color: rgba(200,200,200,.25);  color: var(--text); background-color: rgb(200,200,200, 0.2);}
    .badge.normal { border-color: var(--accent-color); color: var(--text);  background-color: color-mix(in srgb, var(--accent-color) 30%, transparent);}
    .badge.quantity { border-color: var(--accent-color); font-weight: 700; color: var(--accent);}
    .item .del {
      flex-shrink: 0;
      padding: 6px 10px;
      font-size: 12px;
    }
    .danger-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .item .edit {
      flex-shrink: 0;
      padding: 6px 10px;
      font-size: 12px;
    }
    .item .icon-btn {
      padding: 0;
      width: 28px;
      height: 28px;
      box-sizing: border-box;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .item .drag-handle {
      flex-shrink: 0;
      width: 28px;
      height: 28px;
      box-sizing: border-box;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--card);
      cursor: grab;
      display: flex;
      align-items: center;
      justify-content: center;
      user-select: none;
    }
    .item .drag-handle:active { cursor: grabbing; }
    .item .drag-handle i {
      color: var(--muted);
      font-size: 16px;
      pointer-events: none;
    }
    .item.dragging {
      background: var(--accent);
      z-index: 10;
    }
    .item.drag-over {
      outline: 0px dashed var(--accent);
      outline-offset: 0px;
    }
    .done { opacity: .5; }
    .done .title { text-decoration: line-through; }
    .empty { color: var(--muted); padding: 10px; }
    .section-header {
      font-size: 12px;
      font-weight: 600;
      color: var(--muted);
      padding: 8px 4px 4px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .stats {
      display: flex;
      gap: var(--gap);
      margin-bottom: var(--gap);
    }
    .stat-box {
      flex: 1;
      padding: 12px 8px;
      border-radius: var(--radius);
      background: var(--card);
      border: 1px solid var(--border);
      text-align: center;
    }
    .stat-box .label {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 4px;
    }
    .stat-box .value {
      font-size: 28px;
      font-weight: 700;
    }
    .stat-open .label, .stat-open .value { color: var(--accent); }
    .stat-overdue .label, .stat-overdue .value { color: #ff5a5a; }
    .stat-today .label, .stat-today .value { color: #ffa500; }
    .toolbar {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: var(--gap);
      flex-wrap: nowrap;
    }
    .toolbar .sort {
      display: flex;
      align-items: center;
      gap: 8px;
      min-width: 0;
      flex: 1;
    }
    .select-wrap {
      position: relative;
      flex: 1;
      min-width: 0;
      color: var(--text);
    }
    .select-wrap select {
      padding-right: 40px;
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
    }
    .select-wrap .select-icon {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      pointer-events: none;
      color: inherit;
    }
    .toolbar.manual-sort #sortAsc,
    .toolbar.manual-sort #sortDesc {
      display: none;
    }
    #sortLabel { white-space: nowrap; }
    #sortSelect {
      min-width: 0;
      height: 28px;
      padding: 0 40px 0 12px;
      line-height: 28px;
    }
    .toolbar .sort-btn {
      height: 28px;
      width: 28px;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="stats">
      <div class="stat-box stat-open">
        <div class="label" id="statOpenLabel"></div>
        <div class="value" id="statOpenValue">0</div>
      </div>
      <div class="stat-box stat-overdue">
        <div class="label" id="statOverdueLabel"></div>
        <div class="value" id="statOverdueValue">0</div>
      </div>
      <div class="stat-box stat-today">
        <div class="label" id="statTodayLabel"></div>
        <div class="value" id="statTodayValue">0</div>
      </div>
    </div>
    <button id="newBtn" class="primary"> </button>

    <div class="toolbar">
      <div class="sort">
        <div id="sortLabel"></div>
        <div class="select-wrap">
          <select id="sortSelect"></select>
          <i class="fa-light fa-arrow-down-from-bracket select-icon"></i>
        </div>
      </div>
      <button class="sort-btn icon-btn" id="sortAsc" type="button"><i class="fa-light fa-arrow-up"></i></button>
      <button class="sort-btn icon-btn" id="sortDesc" type="button"><i class="fa-light fa-arrow-down"></i></button>
    </div>

    <div id="list" class="list"></div>

    <div id="overlay" class="overlay">
      <div class="overlay-card">
        <div id="formTitle" class="overlay-title"></div>
        <div class="overlay-body">
          <div class="add">
            <input id="title" type="text" class="full" />
            <input id="info" type="text" class="full" />
            <div class="full date-input">
              <input id="due" type="datetime-local" />
              <div id="duePlaceholder" class="date-placeholder"></div>
              <i class="fa-light fa-calendar cal-icon"></i>
            </div>
            <div id="notificationFieldLabel" class="full field-label"></div>
            <div class="full checkrow"><label><input id="notification" type="checkbox" /><span id="notificationLabel"></span></label><div class="select-wrap"><select id="notificationLeadTime"></select><i class="fa-light fa-arrow-down-from-bracket select-icon"></i></div></div>
            <div id="notificationLeadTimeInfo" class="full hint"></div>
            <input id="quantity" type="number" min="0" class="full" />
            <div class="full select-wrap">
              <select id="prio">
                <option value="low"></option>
                <option value="normal" selected></option>
                <option value="high"></option>
              </select>
              <i class="fa-light fa-arrow-down-from-bracket select-icon"></i>
            </div>
          </div>
        </div>
        <div class="overlay-actions">
          <button id="deleteBtn" class="danger danger-btn" type="button"><i class="fa-light fa-trash-can"></i><span id="deleteBtnText"></span></button>
          <button id="cancelBtn" type="button"></button>
          <button id="addBtn" class="primary"></button>
        </div>
      </div>
    </div>

    <div id="detailOverlay" class="overlay">
      <div class="overlay-card detail-card">
        <div class="overlay-body">
          <div id="detailHeader" class="overlay-title"></div>
          <div id="detailTaskTitle" class="detail-title"></div>
          <div id="detailTaskInfo" class="detail-info"></div>
          <div id="detailMeta" class="detail-meta"></div>
        </div>
        <div class="overlay-actions">
          <button id="detailCloseBtn" class="primary"></button>
        </div>
      </div>
    </div>
  </div>

  <script>
    let state = { items: [] };
    let editingId = 0;
    let dragItem = null;
    let dragGroup = '';
    let dndBound = false;
    let sortMode = 'created';
    let sortDir = 'desc';
    let lastOrderVersion = null;

    const sortStorageKey = `TDL.Sort.${location.pathname}${location.search}`;

    function loadSortPrefs() {
      try {
        const raw = localStorage.getItem(sortStorageKey);
        if (!raw) return;
        const v = JSON.parse(raw);
        const mode = String(v?.mode || '');
        const dir = String(v?.dir || '');
        const allowedModes = new Set(['manual', 'created', 'due', 'priority', 'title']);
        if (allowedModes.has(mode)) {
          sortMode = mode;
        }
        if (dir === 'asc' || dir === 'desc') {
          sortDir = dir;
        }
      } catch (e) {
      }
    }

    function saveSortPrefs() {
      try {
        localStorage.setItem(sortStorageKey, JSON.stringify({ mode: sortMode, dir: sortDir }));
      } catch (e) {
      }
    }

    function applyUiVisibility() {
      const showOverview = state.showOverview !== false;
      const showCreateButton = state.showCreateButton !== false;
      const showSorting = state.showSorting !== false;

      const stats = document.querySelector('.stats');
      if (stats) stats.style.display = showOverview ? '' : 'none';

      const newBtn = document.getElementById('newBtn');
      if (newBtn) newBtn.style.display = showCreateButton ? '' : 'none';

      const toolbar = document.querySelector('.toolbar');
      if (toolbar) toolbar.style.display = showSorting ? '' : 'none';
    }

    function setManualSort() {
      sortMode = 'manual';
      const sel = document.getElementById('sortSelect');
      if (sel) sel.value = 'manual';
      updateSortButtons();
      saveSortPrefs();
    }

    function initTexts() {
      document.getElementById('formTitle').textContent = translate('New Task');
      document.getElementById('addBtn').textContent = translate('Add');
      document.getElementById('deleteBtnText').textContent = translate('Delete');

      document.getElementById('statOpenLabel').textContent = translate('Open Tasks');
      document.getElementById('statOverdueLabel').textContent = translate('Overdue');
      document.getElementById('statTodayLabel').textContent = translate('Due Today');

      document.getElementById('title').title = translate('Title');
      document.getElementById('title').placeholder = translate('Title');
      document.getElementById('info').title = translate('Info');
      document.getElementById('info').placeholder = translate('Info');
      document.getElementById('quantity').title = translate('Quantity');
      document.getElementById('quantity').placeholder = translate('Quantity');
      document.getElementById('due').title = translate('Due');
      document.getElementById('duePlaceholder').textContent = translate('Due placeholder');
      document.getElementById('notificationFieldLabel').textContent = translate('Notification');

      document.getElementById('sortLabel').textContent = translate('Sort');
      const sort = document.getElementById('sortSelect');
      sort.innerHTML = '';
      const sortOpts = [
        { v: 'manual', t: 'Sort by manual' },
        { v: 'created', t: 'Sort by creation' },
        { v: 'due', t: 'Sort by due' },
        { v: 'priority', t: 'Sort by priority' },
        { v: 'title', t: 'Sort by title' }
      ];
      for (const o of sortOpts) {
        const el = document.createElement('option');
        el.value = o.v;
        el.textContent = translate(o.t);
        sort.appendChild(el);
      }
      sort.value = sortMode;

      document.getElementById('sortAsc').title = translate('Ascending');
      document.getElementById('sortDesc').title = translate('Descending');

      const lt = document.getElementById('notificationLeadTime');
      lt.innerHTML = '';
      const opts = [
        { v: 0, t: '0 minutes' },
        { v: 300, t: '5 minutes' },
        { v: 600, t: '10 minutes' },
        { v: 1800, t: '30 minutes' },
        { v: 3600, t: '1 hour' },
        { v: 18000, t: '5 hours' },
        { v: 43200, t: '12 hours' }
      ];
      for (const o of opts) {
        const el = document.createElement('option');
        el.value = String(o.v);
        el.textContent = translate(o.t);
        lt.appendChild(el);
      }

      const prio = document.getElementById('prio');
      prio.querySelector('option[value="low"]').textContent = translate('Priority low');
      prio.querySelector('option[value="normal"]').textContent = translate('Priority normal');
      prio.querySelector('option[value="high"]').textContent = translate('Priority high');

      document.getElementById('newBtn').textContent = translate('New Task');
      document.getElementById('cancelBtn').textContent = translate('Cancel');

      document.getElementById('detailHeader').textContent = translate('Details');
      document.getElementById('detailCloseBtn').textContent = translate('Close');
    }

    function updateSortButtons() {
      const asc = document.getElementById('sortAsc');
      const desc = document.getElementById('sortDesc');
      const toolbar = document.querySelector('.toolbar');
      if (toolbar) toolbar.classList.toggle('manual-sort', sortMode === 'manual');
      if (sortMode === 'manual') {
        if (asc) {
          asc.disabled = true;
          asc.classList.remove('active');
        }
        if (desc) {
          desc.disabled = true;
          desc.classList.remove('active');
        }
        return;
      }
      if (asc) asc.classList.toggle('active', sortDir === 'asc');
      if (desc) desc.classList.toggle('active', sortDir === 'desc');
      if (asc) asc.disabled = false;
      if (desc) desc.disabled = false;
    }

    function sortItems(items) {
      const list = Array.isArray(items) ? items.slice() : [];

      if (sortMode === 'manual') {
        return list;
      }

      const compareDue = (a, b) => {
        const da = parseInt(a.due) || 0;
        const db = parseInt(b.due) || 0;
        if (da <= 0 && db <= 0) return 0;
        if (da <= 0) return 1;
        if (db <= 0) return -1;
        return sortDir === 'asc' ? (da - db) : (db - da);
      };

      const prioRankLowFirst = (p) => {
        const v = String(p ?? 'normal');
        if (v === 'low') return 0;
        if (v === 'normal') return 1;
        return 2;
      };

      const getCreatedKey = (it) => parseInt(it.createdAt) || 0;
      const getTitleKey = (it) => String(it.title ?? '');
      const getIdKey = (it) => parseInt(it.id) || 0;

      list.sort((a, b) => {
        if (sortMode === 'due') {
          const c = compareDue(a, b);
          if (c !== 0) return c;
          return getIdKey(a) - getIdKey(b);
        }
        if (sortMode === 'priority') {
          const pa = prioRankLowFirst(a.priority);
          const pb = prioRankLowFirst(b.priority);
          if (pa !== pb) {
            return sortDir === 'asc' ? (pa - pb) : (pb - pa);
          }
          const c = compareDue(a, b);
          if (c !== 0) return c;
          return getIdKey(a) - getIdKey(b);
        }
        if (sortMode === 'title') {
          const ta = getTitleKey(a);
          const tb = getTitleKey(b);
          const c = ta.localeCompare(tb, undefined, { sensitivity: 'base' });
          if (c !== 0) return c;
          return getIdKey(a) - getIdKey(b);
        }
        const ca = getCreatedKey(a);
        const cb = getCreatedKey(b);
        if (ca !== cb) return sortDir === 'asc' ? (ca - cb) : (cb - ca);
        return getIdKey(a) - getIdKey(b);
      });

      if (sortMode === 'title' && sortDir === 'desc') {
        list.reverse();
      }
      return list;
    }

    function openOverlay(mode) {
      const overlay = document.getElementById('overlay');
      const title = document.getElementById('formTitle');
      const submit = document.getElementById('addBtn');
      const delBtn = document.getElementById('deleteBtn');

      if (mode === 'edit') {
        title.textContent = translate('Edit Task');
        submit.textContent = translate('Save');
        if (delBtn) delBtn.style.display = '';
      } else {
        title.textContent = translate('New Task');
        submit.textContent = translate('Add');
        if (delBtn) delBtn.style.display = 'none';
      }

      overlay.classList.add('open');
      document.getElementById('title').focus();
    }

    function closeOverlay() {
      document.getElementById('overlay').classList.remove('open');
      editingId = 0;
    }

    function openDetail(id) {
      const it = (Array.isArray(state.items) ? state.items : []).find(x => parseInt(x.id) === parseInt(id));
      if (!it) return;

      document.getElementById('detailTaskTitle').textContent = String(it.title ?? '');
      document.getElementById('detailTaskInfo').textContent = String(it.info ?? '');

      const dueTs = parseInt(it.due) || 0;
      const due = formatDue(dueTs);
      const dueClass = getDueBadgeClass(dueTs);
      const quantity = parseInt(it.quantity) || 0;
      const notification = !!it.notification;
      const prio = String(it.priority ?? 'normal');
      const prioKey = getPriorityKey(prio);
      const prioLabel = getPriorityLabel(prioKey);

      const meta = [];
      if (quantity > 0) meta.push(`<span class="badge quantity">${quantity}×</span>`);
      if (due) meta.push(`<span class="badge due-badge ${dueClass}" title="${escapeHtml(due)}"><i class="fa-light fa-calendar due-icon"></i><span class="due-text">${escapeHtml(due)}</span></span>`);
      if (notification) meta.push(`<span class="badge notify-badge" title="${escapeHtml(translate('Notification'))}"><i class="fa-light fa-message"></i></span>`);
      meta.push(`<span class="badge ${prioKey}">${escapeHtml(prioLabel)}</span>`);
      document.getElementById('detailMeta').innerHTML = meta.join('');

      document.getElementById('detailOverlay').classList.add('open');
    }

    function closeDetail() {
      document.getElementById('detailOverlay').classList.remove('open');
    }

    function getDefaultNotificationLeadTime() {
      const v = parseInt(state.notificationLeadTimeDefault);
      return Number.isFinite(v) ? v : 600;
    }

    function updateNotificationLeadTimeInfo() {
      const chk = document.getElementById('notification');
      const sel = document.getElementById('notificationLeadTime');
      const info = document.getElementById('notificationLeadTimeInfo');
      const show = !chk.disabled && chk.checked;
      info.style.display = show ? '' : 'none';
      if (!show) {
        info.textContent = '';
        return;
      }
      const opt = sel.options[sel.selectedIndex];
      const text = opt ? opt.textContent : '';
      info.textContent = translate('Notify before due').replace('{0}', text);
    }

    function updateNotificationLeadTimeUI() {
      const chk = document.getElementById('notification');
      const sel = document.getElementById('notificationLeadTime');
      const enabled = !chk.disabled && chk.checked;
      sel.disabled = !enabled;
      sel.style.display = '';
      if (!sel.value) {
        sel.value = String(getDefaultNotificationLeadTime());
      }
      updateNotificationLeadTimeInfo();
    }

    function updateNotificationAvailability() {
      const dueStr = document.getElementById('due').value || '';
      const chk = document.getElementById('notification');
      const enabled = dueStr !== '';
      chk.disabled = !enabled;
      updateDuePlaceholder();
      if (!enabled) {
        chk.checked = false;
      }
      updateNotificationLeadTimeUI();
    }

    function updateDuePlaceholder() {
      const due = document.getElementById('due');
      const ph = document.getElementById('duePlaceholder');
      if (!due || !ph) {
        return;
      }
      const hasValue = (due.value || '') !== '';
      const isFocused = document.activeElement === due;
      const wrap = due.closest('.date-input');
      if (wrap) {
        wrap.classList.toggle('has-value', hasValue);
        wrap.classList.toggle('is-focused', isFocused);
      }
      ph.style.display = (!hasValue && !isFocused) ? '' : 'none';
    }

    function resetForm() {
      document.getElementById('title').value = '';
      document.getElementById('info').value = '';
      document.getElementById('notification').checked = false;
      document.getElementById('notificationLeadTime').value = String(getDefaultNotificationLeadTime());
      document.getElementById('due').value = '';
      document.getElementById('prio').value = 'normal';
      document.getElementById('quantity').value = '';
      updateNotificationAvailability();
    }

    function timestampToLocalInput(ts) {
      const t = parseInt(ts);
      if (!Number.isFinite(t) || t <= 0) return '';
      const d = new Date(t * 1000);
      if (isNaN(d.getTime())) return '';
      const pad = (n) => String(n).padStart(2, '0');
      return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }

    function openNew() {
      resetForm();
      editingId = 0;
      openOverlay('new');
    }

    function openEdit(id) {
      const it = (Array.isArray(state.items) ? state.items : []).find(x => parseInt(x.id) === parseInt(id));
      if (!it) return;

      editingId = parseInt(it.id);
      document.getElementById('title').value = String(it.title ?? '');
      document.getElementById('info').value = String(it.info ?? '');
      document.getElementById('notification').checked = !!it.notification;
      document.getElementById('notificationLeadTime').value = String(parseInt(it.notificationLeadTime) || getDefaultNotificationLeadTime());
      document.getElementById('prio').value = String(it.priority ?? 'normal');
      document.getElementById('due').value = timestampToLocalInput(it.due ?? 0);
      document.getElementById('quantity').value = parseInt(it.quantity) || '';
      updateNotificationAvailability();
      openOverlay('edit');
    }

    function renderItem(it) {
      const id = String(it.id);
      const title = escapeHtml(it.title ?? '');
      const info = escapeHtml(it.info ?? '');
      const done = !!it.done;
      const dueTs = parseInt(it.due) || 0;
      const due = formatDue(dueTs);
      const dueClass = getDueBadgeClass(dueTs);
      const rawQty = parseInt(it.quantity);
      const notification = !!it.notification;
      const prio = String(it.priority ?? 'normal');
      const prioKey = getPriorityKey(prio);
      const prioLabel = getPriorityLabel(prioKey);
      const group = done ? 'completed' : 'active';
      const showInfoBadges = state.showInfoBadges === true;
      const showDeleteButton = state.showDeleteButton !== false;
      const showEditButton = state.showEditButton !== false;
      const useGridView = state.useGridView === true;
      const showLargeQuantity = useGridView && state.showLargeQuantity === true;
      const shoppingMode = useGridView && state.gridShoppingListMode === true;

      const quantity = shoppingMode
        ? ((Number.isFinite(rawQty) && rawQty > 0) ? rawQty : 1)
        : ((Number.isFinite(rawQty) && rawQty > 0) ? rawQty : 0);

      const qtyLargeHtml = (!shoppingMode && useGridView && showLargeQuantity && quantity > 0)
        ? `<div class="quantity-large-wrap"><span class="badge quantity large-qty">${quantity}×</span></div>`
        : '';

      const qtyShoppingHtml = (shoppingMode && quantity > 0)
        ? `<div class="shopping-qty-wrap"><span class="badge quantity${showLargeQuantity ? ' large-qty' : ''}">${quantity}×</span></div>`
        : '';

      const meta = [];
      if (!shoppingMode && quantity > 0 && (!useGridView || !showLargeQuantity)) {
        meta.push(`<span class="badge quantity${showLargeQuantity ? ' large-qty' : ''}">${quantity}×</span>`);
      }
      if (!shoppingMode && showInfoBadges && due) {
        meta.push(useGridView
          ? `<span class="badge due-badge ${dueClass} icon-only" title="${escapeHtml(due)}"><i class="fa-light fa-calendar"></i></span>`
          : `<span class="badge due-badge ${dueClass}" title="${escapeHtml(due)}"><i class="fa-light fa-calendar due-icon"></i><span class="due-text">${escapeHtml(due)}</span></span>`);
      }
      if (!shoppingMode && showInfoBadges && notification) {
        meta.push(`<span class="badge notify-badge${useGridView ? ' icon-only' : ''}" title="${escapeHtml(translate('Notification'))}"><i class="fa-light fa-message"></i></span>`);
      }
      if (!shoppingMode && showInfoBadges) {
        meta.push(useGridView
          ? `<span class="badge ${prioKey} icon-only" title="${escapeHtml(prioLabel)}"><i class="fa-light fa-flag"></i></span>`
          : `<span class="badge ${prioKey}">${escapeHtml(prioLabel)}</span>`);
      }

      const actionButtons = `${showDeleteButton ? `<button class="del icon-btn" title="${translate('Delete')}" aria-label="${translate('Delete')}"><i class="fa-light fa-trash-can"></i></button>` : ''}
            ${showEditButton ? `<button class="edit icon-btn" title="${translate('Edit')}" aria-label="${translate('Edit')}"><i class="fa-light fa-pencil"></i></button>` : ''}
            <div class="drag-handle" draggable="true"><i class="fa-light fa-grip-dots-vertical"></i></div>`;

      const actionsHtml = useGridView
        ? `<div class="meta">${meta.join('')}</div><div class="grid-actions">${actionButtons}</div>`
        : `<div class="meta">${meta.join('')}</div>${actionButtons}`;

      return `
        <div class="item ${done ? 'done' : ''}" data-id="${id}" data-done="${done ? '1' : '0'}" data-group="${group}">
          <div class="main">
            <input type="checkbox" class="chk" ${done ? 'checked' : ''} />
            <div class="content">
              <div class="title">${title}</div>
              ${info ? `<div class="info">${info}</div>` : ''}
              ${shoppingMode ? qtyShoppingHtml : qtyLargeHtml}
            </div>
          </div>
          <div class="actions">
            ${actionsHtml}
          </div>
        </div>
      `;
    }

    function bindDnd(container) {
      if (!dndBound) {
        container.addEventListener('dragover', (e) => {
          if (!dragItem) return;
          e.preventDefault();

          const target = e.target.closest('.item');
          if (!target || target === dragItem) return;
          if ((target.getAttribute('data-group') || '') !== dragGroup) return;

          const rect = target.getBoundingClientRect();
          const after = (e.clientY - rect.top) > (rect.height / 2);

          container.querySelectorAll('.item.drag-over').forEach(x => x.classList.remove('drag-over'));
          target.classList.add('drag-over');

          if (after) {
            target.after(dragItem);
          } else {
            target.before(dragItem);
          }
        });

        container.addEventListener('drop', (e) => {
          if (!dragItem) return;
          e.preventDefault();

          container.querySelectorAll('.item.drag-over').forEach(x => x.classList.remove('drag-over'));

          const activeIds = Array.from(container.querySelectorAll('.item[data-group="active"]'))
            .map(el => parseInt(el.getAttribute('data-id')))
            .filter(n => Number.isFinite(n));
          let completedIds = Array.from(container.querySelectorAll('.item[data-group="completed"]'))
            .map(el => parseInt(el.getAttribute('data-id')))
            .filter(n => Number.isFinite(n));

          const hideCompleted = state.hideCompletedTasks === true;
          if (hideCompleted) {
            completedIds = (Array.isArray(state.items) ? state.items : [])
              .filter(it => !!it.done)
              .map(it => parseInt(it.id))
              .filter(n => Number.isFinite(n));
          }

          setManualSort();
          requestAction('Reorder', JSON.stringify({ order: activeIds.concat(completedIds) }));
        });

        dndBound = true;
      }

      container.querySelectorAll('.drag-handle').forEach(handle => {
        handle.addEventListener('dragstart', (e) => {
          const item = handle.closest('.item');
          if (!item) return;
          dragItem = item;
          dragGroup = item.getAttribute('data-group') || '';
          item.classList.add('dragging');

          if (e.dataTransfer) {
            e.dataTransfer.effectAllowed = 'move';
            try {
              e.dataTransfer.setData('text/plain', item.getAttribute('data-id') || '');
            } catch (err) {
            }
            const ghost = document.createElement('div');
            ghost.style.width = '1px';
            ghost.style.height = '1px';
            ghost.style.opacity = '0.01';
            document.body.appendChild(ghost);
            e.dataTransfer.setDragImage(ghost, 0, 0);
            setTimeout(() => ghost.remove(), 0);
          }
        });

        handle.addEventListener('dragend', () => {
          if (dragItem) {
            dragItem.classList.remove('dragging');
          }
          container.querySelectorAll('.item.drag-over').forEach(x => x.classList.remove('drag-over'));
          dragItem = null;
          dragGroup = '';
        });
      });
    }

    function updateStats() {
      const items = Array.isArray(state.items) ? state.items : [];
      const now = new Date();
      const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime() / 1000;
      const todayEnd = todayStart + 86400;

      let open = 0, overdue = 0, today = 0;
      items.forEach(it => {
        if (it.done) return;
        open++;
        const due = parseInt(it.due) || 0;
        if (due > 0) {
          if (due < todayStart) overdue++;
          else if (due >= todayStart && due < todayEnd) today++;
        }
      });

      document.getElementById('statOpenValue').textContent = open;
      document.getElementById('statOverdueValue').textContent = overdue;
      document.getElementById('statTodayValue').textContent = today;
    }

    function render() {
      updateStats();
      const container = document.getElementById('list');
      const items = Array.isArray(state.items) ? state.items : [];
      const hideCompleted = state.hideCompletedTasks === true;

      container.classList.toggle('grid', state.useGridView === true);
      container.classList.toggle('shopping', state.useGridView === true && state.gridShoppingListMode === true);

      if (items.length === 0) {
        container.innerHTML = `<div class="empty">${translate('No items')}</div>`;
        bindDnd(container);
        return;
      }

      const active = sortItems(items.filter(it => !it.done));
      const completed = hideCompleted ? [] : sortItems(items.filter(it => !!it.done));

      let html = active.map(renderItem).join('');

      if (completed.length > 0) {
        html += `<div class="section-header">${translate('Completed')}</div>`;
        html += completed.map(renderItem).join('');
      }

      container.innerHTML = html;

      const shoppingMode = state.useGridView === true && state.gridShoppingListMode === true;

      container.querySelectorAll('.item').forEach(el => {
        const id = parseInt(el.getAttribute('data-id'));
        const chk = el.querySelector('.chk');
        const del = el.querySelector('.del');
        const edit = el.querySelector('.edit');
        const title = el.querySelector('.title');
        const info = el.querySelector('.info');
        const handle = el.querySelector('.drag-handle');

        if (!shoppingMode) {
          chk.addEventListener('change', () => {
            requestAction('ToggleDone', JSON.stringify({ id: id, done: chk.checked }));
          });
        }

        if (del) {
          del.addEventListener('click', (e) => {
            e.stopPropagation();
            requestAction('DeleteItem', JSON.stringify({ id: id }));
          });
        }

        if (edit) {
          edit.addEventListener('click', (e) => {
            e.stopPropagation();
            openEdit(id);
          });
        }

        if (!shoppingMode && title) {
          title.addEventListener('click', (e) => {
            e.stopPropagation();
            openDetail(id);
          });
        }

        if (!shoppingMode && info) {
          info.addEventListener('click', (e) => {
            e.stopPropagation();
            openDetail(id);
          });
        }

        if (shoppingMode) {
          el.addEventListener('click', () => {
            const currentDone = (el.getAttribute('data-done') || '0') === '1';
            requestAction('ToggleDone', JSON.stringify({ id: id, done: !currentDone }));
          });
        }

        if (handle) {
          handle.addEventListener('click', (e) => e.stopPropagation());
        }
      });

      bindDnd(container);
    }

    function handleMessage(data) {
      if (typeof data === 'string') {
        try {
          data = JSON.parse(data);
        } catch (e) {
          return;
        }
      }
      if (data && typeof data === 'object' && data.type === 'state') {
        const ov = parseInt(data.orderVersion) || 0;
        if (lastOrderVersion === null) {
          lastOrderVersion = ov;
        } else if (ov !== lastOrderVersion) {
          setManualSort();
          lastOrderVersion = ov;
        }
        state = data;
        applyUiVisibility();
        render();
      }
    }

    window.addEventListener('message', (event) => {
      if (!event) return;
      handleMessage(event.data);
    });

    function requestState() {
      requestAction('GetState', 0);
    }

    function getPriorityLabel(prio) {
      switch (String(prio)) {
        case 'low':
          return translate('Low');
        case 'high':
          return translate('High');
        default:
          return translate('Normal');
      }
    }

    function getPriorityKey(prio) {
      switch (String(prio)) {
        case 'low':
          return 'low';
        case 'high':
          return 'high';
        default:
          return 'normal';
      }
    }

    function formatDue(ts) {
      const t = parseInt(ts);
      if (!Number.isFinite(t) || t <= 0) return '';
      const d = new Date(t * 1000);
      const date = d.toLocaleDateString(undefined, { year: 'numeric', month: '2-digit', day: '2-digit' });
      const time = d.toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit' });
      return `${date} ${time}`;
    }

    function getDueBadgeClass(ts) {
      const t = parseInt(ts);
      if (!Number.isFinite(t) || t <= 0) return '';

      const now = new Date();
      const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime() / 1000;
      const todayEnd = todayStart + 86400;

      if (t < todayStart) return 'due-overdue';
      if (t >= todayStart && t < todayEnd) return 'due-today';
      return '';
    }

    function escapeHtml(s) {
      return String(s)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#039;');
    }

    document.addEventListener('DOMContentLoaded', () => {
      loadSortPrefs();
      initTexts();
      applyUiVisibility();

      document.getElementById('sortSelect').addEventListener('change', () => {
        sortMode = document.getElementById('sortSelect').value || 'created';
        updateSortButtons();
        saveSortPrefs();
        render();
      });
      document.getElementById('sortAsc').addEventListener('click', () => {
        if (sortMode === 'manual') return;
        sortDir = 'asc';
        updateSortButtons();
        saveSortPrefs();
        render();
      });
      document.getElementById('sortDesc').addEventListener('click', () => {
        if (sortMode === 'manual') return;
        sortDir = 'desc';
        updateSortButtons();
        saveSortPrefs();
        render();
      });
      updateSortButtons();

      document.getElementById('due').addEventListener('input', updateNotificationAvailability);
      document.getElementById('due').addEventListener('change', updateNotificationAvailability);
      document.getElementById('due').addEventListener('focus', updateDuePlaceholder);
      document.getElementById('due').addEventListener('blur', updateDuePlaceholder);
      document.getElementById('notification').addEventListener('change', updateNotificationLeadTimeUI);
      document.getElementById('notificationLeadTime').addEventListener('click', (e) => e.stopPropagation());
      document.getElementById('notificationLeadTime').addEventListener('change', updateNotificationLeadTimeInfo);
      updateNotificationAvailability();

      document.getElementById('newBtn').addEventListener('click', () => {
        openNew();
      });

      document.getElementById('cancelBtn').addEventListener('click', () => {
        closeOverlay();
      });

      document.getElementById('deleteBtn').addEventListener('click', () => {
        if (editingId > 0) {
          requestAction('DeleteItem', JSON.stringify({ id: editingId }));
        }
        closeOverlay();
      });

      document.getElementById('detailCloseBtn').addEventListener('click', () => {
        closeDetail();
      });

      document.getElementById('addBtn').addEventListener('click', () => {
        const title = (document.getElementById('title').value || '').trim();
        const info = (document.getElementById('info').value || '').trim();
        const notification = !!document.getElementById('notification').checked;
        const notificationLeadTime = parseInt(document.getElementById('notificationLeadTime').value) || getDefaultNotificationLeadTime();
        const dueStr = document.getElementById('due').value || '';
        const prio = document.getElementById('prio').value || 'normal';
        const quantity = parseInt(document.getElementById('quantity').value) || 0;

        if (title === '') return;

        let due = 0;
        if (dueStr) {
          const d = new Date(dueStr);
          if (!isNaN(d.getTime())) {
            due = Math.floor(d.getTime() / 1000);
          }
        }

        resetForm();

        if (editingId > 0) {
          requestAction('UpdateItem', JSON.stringify({ id: editingId, title, info, due, priority: prio, quantity, notification, notificationLeadTime }));
        } else {
          requestAction('AddItem', JSON.stringify({ title, info, due, priority: prio, quantity, notification, notificationLeadTime }));
        }
        closeOverlay();
      });

      requestState();
    });
  </script>
</body>
</html>
